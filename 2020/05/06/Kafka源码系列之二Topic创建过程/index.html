<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Kafka源码系列之二Topic创建过程
  
</title>

<meta name="description" content="Topic的创建过程">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka源码系列之二Topic创建过程">
<meta property="og:url" content="http://yoursite.com/2020/05/06/Kafka%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BA%8CTopic%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/index.html">
<meta property="og:site_name" content="BlackC">
<meta property="og:description" content="Topic的创建过程">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-05-06T07:42:41.000Z">
<meta property="article:modified_time" content="2021-03-21T12:33:13.852Z">
<meta property="article:author" content="X&amp;Z">
<meta property="article:tag" content="kafka">
<meta name="twitter:card" content="summary">


  <link rel="alternative" href="/atom.xml" title="BlackC" type="application/atom+xml">



  <link rel="icon" href="/images/favicon.ico">



<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">


<link rel="stylesheet" href="/styles/main.css">







<meta name="generator" content="Hexo 5.4.0"></head>
<body
  
    class="monochrome"
  
  >
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">BlackC</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">BlackC</a></h1>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">X&amp;Z</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="/images/avatar.jpg"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">分类</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><span class="category-list-count">170</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%90%AD%E5%BB%BA/">搭建</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%99%E7%A8%8B/">教程</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E8%AE%B0/">杂记</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F/">系统</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E8%AF%91/">编译</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E8%BE%91%E5%99%A8/">编辑器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">10</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">标签</a>
                <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alibaba/" rel="tag">alibaba</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cas/" rel="tag">cas</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cdh/" rel="tag">cdh</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/doris/" rel="tag">doris</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edit/" rel="tag">edit</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elk/" rel="tag">elk</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink/" rel="tag">flink</a><span class="tag-list-count">96</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grafana/" rel="tag">grafana</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/greenplum/" rel="tag">greenplum</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hbase/" rel="tag">hbase</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hive/" rel="tag">hive</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kylin/" rel="tag">kylin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/learn/" rel="tag">learn</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/miscellany/" rel="tag">miscellany</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mr/" rel="tag">mr</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/neo4j/" rel="tag">neo4j</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/os/" rel="tag">os</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oss/" rel="tag">oss</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/profile/" rel="tag">profile</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prometheus/" rel="tag">prometheus</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sbt/" rel="tag">sbt</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/" rel="tag">spark</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/" rel="tag">tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xwiki/" rel="tag">xwiki</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zk/" rel="tag">zk</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">归档</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">90</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">80</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a><span class="archive-list-count">18</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">10</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="主页" external="false">主页</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="文章" external="false">文章</a>
              </li>
            
          
            
              <li>
                <a href="/about" title="关于" external="false">关于</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/denjones/hexo-theme-chan" title="样式" target="_blank" rel="noopener">样式</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/jxeditor" title="Github" target="_blank" rel="noopener">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS" external="false">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          <article id="post-Kafka源码系列之二Topic创建过程" class="article article-type-post">
  
    <h1 class="article-header">
      Kafka源码系列之二Topic创建过程
    </h1>
  
  

  <div class="article-info">
    <span class="article-date">
  2020-05-06
</span>

    
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li></ul>
	</span>


    
	<span class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li></ul>
	</span>


  </div>
  <div class="article-entry">
    <blockquote>
<p>Topic的创建过程</p>
</blockquote>
<span id="more"></span>

<h2 id="Topic的创建"><a href="#Topic的创建" class="headerlink" title="Topic的创建"></a>Topic的创建</h2><h3 id="kafka-topic-sh"><a href="#kafka-topic-sh" class="headerlink" title="kafka-topic.sh"></a>kafka-topic.sh</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exec $(dirname $0)/kafka-run-class.sh kafka.admin.TopicCommand &quot;$@&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createTopic</span></span>(zkClient: <span class="type">KafkaZkClient</span>, opts: <span class="type">TopicCommandOptions</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> topic = opts.options.valueOf(opts.topicOpt)</span><br><span class="line">    <span class="keyword">val</span> configs = parseTopicConfigsToBeAdded(opts)</span><br><span class="line">    <span class="keyword">val</span> ifNotExists = opts.options.has(opts.ifNotExistsOpt)</span><br><span class="line">    <span class="keyword">if</span> (<span class="type">Topic</span>.hasCollisionChars(topic))</span><br><span class="line">      println(<span class="string">&quot;WARNING: Due to limitations in metric names, topics with a period (&#x27;.&#x27;) or underscore (&#x27;_&#x27;) could collide. To avoid issues it is best to use either, but not both.&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> adminZkClient = <span class="keyword">new</span> <span class="type">AdminZkClient</span>(zkClient)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (opts.options.has(opts.replicaAssignmentOpt)) &#123; <span class="comment">// 指定replica的分配,直接向zk更新</span></span><br><span class="line">        <span class="keyword">val</span> assignment = parseReplicaAssignment(opts.options.valueOf(opts.replicaAssignmentOpt))</span><br><span class="line">        adminZkClient.createOrUpdateTopicPartitionAssignmentPathInZK(topic, assignment, configs, update = <span class="literal">false</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// 未指定replica的分配,调用自动分配算法进行分配</span></span><br><span class="line">        <span class="type">CommandLineUtils</span>.checkRequiredArgs(opts.parser, opts.options, opts.partitionsOpt, opts.replicationFactorOpt)</span><br><span class="line">        <span class="keyword">val</span> partitions = opts.options.valueOf(opts.partitionsOpt).intValue</span><br><span class="line">        <span class="keyword">val</span> replicas = opts.options.valueOf(opts.replicationFactorOpt).intValue</span><br><span class="line">        <span class="keyword">val</span> rackAwareMode = <span class="keyword">if</span> (opts.options.has(opts.disableRackAware)) <span class="type">RackAwareMode</span>.<span class="type">Disabled</span></span><br><span class="line">                            <span class="keyword">else</span> <span class="type">RackAwareMode</span>.<span class="type">Enforced</span></span><br><span class="line">        adminZkClient.createTopic(topic, partitions, replicas, configs, rackAwareMode)</span><br><span class="line">      &#125;</span><br><span class="line">      println(<span class="string">&quot;Created topic \&quot;%s\&quot;.&quot;</span>.format(topic))</span><br><span class="line">    &#125; <span class="keyword">catch</span>  &#123;</span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">TopicExistsException</span> =&gt; <span class="keyword">if</span> (!ifNotExists) <span class="keyword">throw</span> e</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果指定了partition各个replica的分布,那么将partition replicas的结果验证之后直接更新到zk上</span></span><br><span class="line"><span class="comment">// 验证replicas的代码在parseReplicaAssignment中实现</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseReplicaAssignment</span></span>(replicaAssignmentList: <span class="type">String</span>): <span class="type">Map</span>[<span class="type">Int</span>, <span class="type">List</span>[<span class="type">Int</span>]] = &#123;</span><br><span class="line">    <span class="keyword">val</span> partitionList = replicaAssignmentList.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> ret = <span class="keyword">new</span> mutable.<span class="type">HashMap</span>[<span class="type">Int</span>, <span class="type">List</span>[<span class="type">Int</span>]]()</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until partitionList.size) &#123;</span><br><span class="line">      <span class="keyword">val</span> brokerList = partitionList(i).split(<span class="string">&quot;:&quot;</span>).map(s =&gt; s.trim().toInt)</span><br><span class="line">      <span class="keyword">val</span> duplicateBrokers = <span class="type">CoreUtils</span>.duplicates(brokerList)</span><br><span class="line">      <span class="comment">// 同一个partition对应的replica是不能相同的</span></span><br><span class="line">      <span class="keyword">if</span> (duplicateBrokers.nonEmpty)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">AdminCommandFailedException</span>(<span class="string">&quot;Partition replica lists may not contain duplicate entries: %s&quot;</span>.format(duplicateBrokers.mkString(<span class="string">&quot;,&quot;</span>)))</span><br><span class="line">      ret.put(i, brokerList.toList)</span><br><span class="line">      <span class="comment">// 同一个topic的副本数必须相同</span></span><br><span class="line">      <span class="keyword">if</span> (ret(i).size != ret(<span class="number">0</span>).size)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">AdminOperationException</span>(<span class="string">&quot;Partition &quot;</span> + i + <span class="string">&quot; has different replication factor: &quot;</span> + brokerList)</span><br><span class="line">    &#125;</span><br><span class="line">    ret.toMap</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果没有指定的partition replicas分配的话,将会调用adminZkClient.createTopic方法创建topic</span></span><br><span class="line"><span class="comment">// 这个方法首先会检测当前的kafka集群是否机架感知</span></span><br><span class="line"><span class="comment">// 如果有,先获取Broker的机架信息,接着使用Replica自动分配算法分配Partition的replica</span></span><br><span class="line"><span class="comment">// 最后将replicas的结果更新到zk上</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createTopic</span></span>(topic: <span class="type">String</span>,</span><br><span class="line">                  partitions: <span class="type">Int</span>,</span><br><span class="line">                  replicationFactor: <span class="type">Int</span>,</span><br><span class="line">                  topicConfig: <span class="type">Properties</span> = <span class="keyword">new</span> <span class="type">Properties</span>,</span><br><span class="line">                  rackAwareMode: <span class="type">RackAwareMode</span> = <span class="type">RackAwareMode</span>.<span class="type">Enforced</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> brokerMetadatas = getBrokerMetadatas(rackAwareMode)</span><br><span class="line">    <span class="keyword">val</span> replicaAssignment = <span class="type">AdminUtils</span>.assignReplicasToBrokers(brokerMetadatas, partitions, replicationFactor)</span><br><span class="line">    createOrUpdateTopicPartitionAssignmentPathInZK(topic, replicaAssignment, topicConfig)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Producer创建Topic"><a href="#Producer创建Topic" class="headerlink" title="Producer创建Topic"></a>Producer创建Topic</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只有当Server端的auto.create.topics.enable设置为true时,Producer向一个不存在的topic发送数据,该topic才会被自动创建</span></span><br><span class="line"><span class="comment">// 当Producer在向一个topic发送produce请求前,会先通过Metadata请求获取这个topic的metadata信息</span></span><br><span class="line"><span class="comment">// Server端在处理Metadata请求时,如果发现获取metadata的topic不存在,但Server允许producer自动创建</span></span><br><span class="line"><span class="comment">// 那么Server将会自动创建该topic</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Replica如何分配"><a href="#Replica如何分配" class="headerlink" title="Replica如何分配"></a>Replica如何分配</h2><h3 id="创建时指定分配"><a href="#创建时指定分配" class="headerlink" title="创建时指定分配"></a>创建时指定分配</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --create --topic <span class="built_in">test</span> --zookeeper XXXX --replica-assignment 1:2,3:4,5:6</span><br><span class="line"><span class="comment"># 该topic有三个分区,分区0的replica分布在1和2上,分区1的replica分布在3和4上,分区2的replica分布在4和5上</span></span><br><span class="line"><span class="comment"># Server端会将该replica分布直接更新到zk上</span></span><br></pre></td></tr></table></figure>
<h3 id="replicas自动分配"><a href="#replicas自动分配" class="headerlink" title="replicas自动分配"></a>replicas自动分配</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 副本分配时,有三个原则:</span></span><br><span class="line"><span class="comment">   * 1. 将副本平均分布在所有的 Broker 上;</span></span><br><span class="line"><span class="comment">   * 2. partition 的多个副本应该分配在不同的 Broker 上;</span></span><br><span class="line"><span class="comment">   * 3. 如果所有的 Broker 有机架信息的话, partition 的副本应该分配到不同的机架上。</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * 为实现上面的目标,在没有机架感知的情况下，应该按照下面两个原则分配 replica:</span></span><br><span class="line"><span class="comment">   * 1. 从 broker.list 随机选择一个 Broker,使用 round-robin 算法分配每个 partition 的第一个副本;</span></span><br><span class="line"><span class="comment">   * 2. 对于这个 partition 的其他副本,逐渐增加 Broker.id 来选择 replica 的分配。</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param brokerMetadatas</span></span><br><span class="line"><span class="comment">   * @param nPartitions</span></span><br><span class="line"><span class="comment">   * @param replicationFactor</span></span><br><span class="line"><span class="comment">   * @param fixedStartIndex</span></span><br><span class="line"><span class="comment">   * @param startPartitionId</span></span><br><span class="line"><span class="comment">   * @return</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assignReplicasToBrokers</span></span>(brokerMetadatas: <span class="type">Seq</span>[<span class="type">BrokerMetadata</span>],</span><br><span class="line">                              nPartitions: <span class="type">Int</span>,</span><br><span class="line">                              replicationFactor: <span class="type">Int</span>,</span><br><span class="line">                              fixedStartIndex: <span class="type">Int</span> = <span class="number">-1</span>,</span><br><span class="line">                              startPartitionId: <span class="type">Int</span> = <span class="number">-1</span>): <span class="type">Map</span>[<span class="type">Int</span>, <span class="type">Seq</span>[<span class="type">Int</span>]] = &#123;</span><br><span class="line">    <span class="keyword">if</span> (nPartitions &lt;= <span class="number">0</span>) <span class="comment">// 要增加的分区数要大于0</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InvalidPartitionsException</span>(<span class="string">&quot;Number of partitions must be larger than 0.&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (replicationFactor &lt;= <span class="number">0</span>) <span class="comment">// replicas要大于0</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InvalidReplicationFactorException</span>(<span class="string">&quot;Replication factor must be larger than 0.&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (replicationFactor &gt; brokerMetadatas.size) <span class="comment">// replicas超过了broker数</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InvalidReplicationFactorException</span>(<span class="string">s&quot;Replication factor: <span class="subst">$replicationFactor</span> larger than available brokers: <span class="subst">$&#123;brokerMetadatas.size&#125;</span>.&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (brokerMetadatas.forall(_.rack.isEmpty)) <span class="comment">// 没有开启机架感知</span></span><br><span class="line">      assignReplicasToBrokersRackUnaware(nPartitions, replicationFactor, brokerMetadatas.map(_.id), fixedStartIndex,</span><br><span class="line">        startPartitionId)</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">// 机架感知</span></span><br><span class="line">      <span class="keyword">if</span> (brokerMetadatas.exists(_.rack.isEmpty)) <span class="comment">// 并不是所有机器都有机架感知</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">AdminOperationException</span>(<span class="string">&quot;Not all brokers have rack information for replica rack aware assignment.&quot;</span>)</span><br><span class="line">      assignReplicasToBrokersRackAware(nPartitions, replicationFactor, brokerMetadatas, fixedStartIndex,</span><br><span class="line">        startPartitionId)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 没有开启机架感知模式,使用assignReplicasToBrokersRackUnaware实现</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">assignReplicasToBrokersRackUnaware</span></span>(nPartitions: <span class="type">Int</span>,</span><br><span class="line">                                                 replicationFactor: <span class="type">Int</span>,</span><br><span class="line">                                                 brokerList: <span class="type">Seq</span>[<span class="type">Int</span>],</span><br><span class="line">                                                 fixedStartIndex: <span class="type">Int</span>,</span><br><span class="line">                                                 startPartitionId: <span class="type">Int</span>): <span class="type">Map</span>[<span class="type">Int</span>, <span class="type">Seq</span>[<span class="type">Int</span>]] = &#123;</span><br><span class="line">    <span class="keyword">val</span> ret = mutable.<span class="type">Map</span>[<span class="type">Int</span>, <span class="type">Seq</span>[<span class="type">Int</span>]]()</span><br><span class="line">    <span class="keyword">val</span> brokerArray = brokerList.toArray</span><br><span class="line">    <span class="keyword">val</span> startIndex = <span class="keyword">if</span> (fixedStartIndex &gt;= <span class="number">0</span>) fixedStartIndex <span class="keyword">else</span> rand.nextInt(brokerArray.length) <span class="comment">// 随机选择一个Broker</span></span><br><span class="line">    <span class="keyword">var</span> currentPartitionId = math.max(<span class="number">0</span>, startPartitionId) <span class="comment">// 开始增加的第一个Partition</span></span><br><span class="line">    <span class="keyword">var</span> nextReplicaShift = <span class="keyword">if</span> (fixedStartIndex &gt;= <span class="number">0</span>) fixedStartIndex <span class="keyword">else</span> rand.nextInt(brokerArray.length)</span><br><span class="line">    <span class="keyword">for</span> (_ &lt;- <span class="number">0</span> until nPartitions) &#123; <span class="comment">// 对每个partition进行分配</span></span><br><span class="line">      <span class="keyword">if</span> (currentPartitionId &gt; <span class="number">0</span> &amp;&amp; (currentPartitionId % brokerArray.length == <span class="number">0</span>))</span><br><span class="line">        nextReplicaShift += <span class="number">1</span> <span class="comment">// 防止partition过大时,其中某些partition的分配(leader,follower)完全一样</span></span><br><span class="line">      <span class="keyword">val</span> firstReplicaIndex = (currentPartitionId + startIndex) % brokerArray.length <span class="comment">// partition的第一个replica</span></span><br><span class="line">      <span class="keyword">val</span> replicaBuffer = mutable.<span class="type">ArrayBuffer</span>(brokerArray(firstReplicaIndex))</span><br><span class="line">      <span class="keyword">for</span> (j &lt;- <span class="number">0</span> until replicationFactor - <span class="number">1</span>) <span class="comment">// 其他replica的分配</span></span><br><span class="line">        replicaBuffer += brokerArray(replicaIndex(firstReplicaIndex, nextReplicaShift, j, brokerArray.length))</span><br><span class="line">      ret.put(currentPartitionId, replicaBuffer)</span><br><span class="line">      currentPartitionId += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为partition设置完第一个replica后,其他replica分配的计算</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">replicaIndex</span></span>(firstReplicaIndex: <span class="type">Int</span>, secondReplicaShift: <span class="type">Int</span>, replicaIndex: <span class="type">Int</span>, nBrokers: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> shift = <span class="number">1</span> + (secondReplicaShift + replicaIndex) % (nBrokers - <span class="number">1</span>) <span class="comment">// 在secondReplicaShift的基础上增加一个replicaIndex</span></span><br><span class="line">    (firstReplicaIndex + shift) % nBrokers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="replicas更新到zk后触发的操作"><a href="#replicas更新到zk后触发的操作" class="headerlink" title="replicas更新到zk后触发的操作"></a>replicas更新到zk后触发的操作</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当一个topic的replicas更新到zk上后</span></span><br><span class="line"><span class="comment">// 监控zk这个目录的方法会被触发(KafkaTopicChangeHandler.handleChildChange())</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际调用的是controller.TopicChange</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopicChangeHandler</span>(<span class="params">controller: <span class="type">KafkaController</span>, eventManager: <span class="type">ControllerEventManager</span></span>) <span class="keyword">extends</span> <span class="title">ZNodeChildChangeHandler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">val</span> path: <span class="type">String</span> = <span class="type">TopicsZNode</span>.path</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">handleChildChange</span></span>(): <span class="type">Unit</span> = eventManager.put(controller.<span class="type">TopicChange</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">TopicChange</span> <span class="keyword">extends</span> <span class="title">ControllerEvent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">state</span></span>: <span class="type">ControllerState</span> = <span class="type">ControllerState</span>.<span class="type">TopicChange</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isActive) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">val</span> topics = zkClient.getAllTopicsInCluster.toSet</span><br><span class="line">    <span class="keyword">val</span> newTopics = topics -- controllerContext.allTopics <span class="comment">// 新创建的topic列表</span></span><br><span class="line">    <span class="keyword">val</span> deletedTopics = controllerContext.allTopics -- topics <span class="comment">// 已经删除的topic列表</span></span><br><span class="line">    controllerContext.allTopics = topics</span><br><span class="line">    registerPartitionModificationsHandlers(newTopics.toSeq)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 新创建topic对应的partition列表</span></span><br><span class="line">    <span class="keyword">val</span> addedPartitionReplicaAssignment = zkClient.getReplicaAssignmentForTopics(newTopics)</span><br><span class="line">    deletedTopics.foreach(controllerContext.removeTopic) <span class="comment">// 把已经删除partition的topic过滤掉</span></span><br><span class="line">    addedPartitionReplicaAssignment.foreach &#123;</span><br><span class="line">      <span class="keyword">case</span> (topicAndPartition, newReplicas) =&gt; controllerContext.updatePartitionReplicaAssignment(topicAndPartition, newReplicas) <span class="comment">// 将新增的tp-replicas更新到缓存中</span></span><br><span class="line">    &#125;</span><br><span class="line">    info(<span class="string">s&quot;New topics: [<span class="subst">$newTopics</span>], deleted topics: [<span class="subst">$deletedTopics</span>], new partition replica assignment &quot;</span> +</span><br><span class="line">      <span class="string">s&quot;[<span class="subst">$addedPartitionReplicaAssignment</span>]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (addedPartitionReplicaAssignment.nonEmpty) <span class="comment">// 处理新创建的topic</span></span><br><span class="line">      onNewPartitionCreation(addedPartitionReplicaAssignment.keySet)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 此回调由topic更改回调调用，并将失败的代理列表作为输入。</span></span><br><span class="line"><span class="comment"> * 1. 将新创建的分区移到NewPartition状态</span></span><br><span class="line"><span class="comment"> * 2. 从NewPartition-&gt;OnlinePartition状态移动新创建的分区</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">onNewPartitionCreation</span></span>(newPartitions: <span class="type">Set</span>[<span class="type">TopicPartition</span>]) &#123;</span><br><span class="line">  info(<span class="string">s&quot;New partition creation callback for <span class="subst">$&#123;newPartitions.mkString(&quot;,&quot;)&#125;</span>&quot;</span>)</span><br><span class="line">  partitionStateMachine.handleStateChanges(newPartitions.toSeq, <span class="type">NewPartition</span>) <span class="comment">// 创建Partition对象,并将其状态置为NewPartition状态</span></span><br><span class="line">  replicaStateMachine.handleStateChanges(controllerContext.replicasForPartition(newPartitions).toSeq, <span class="type">NewReplica</span>) <span class="comment">// 创建Replica对象,并将其状态置为NewReplica状态</span></span><br><span class="line">  partitionStateMachine.handleStateChanges(newPartitions.toSeq, <span class="type">OnlinePartition</span>, <span class="type">Option</span>(<span class="type">OfflinePartitionLeaderElectionStrategy</span>)) <span class="comment">// 将Partition对象从NewPartition状态改为OnlinePartition状态</span></span><br><span class="line">  replicaStateMachine.handleStateChanges(controllerContext.replicasForPartition(newPartitions).toSeq, <span class="type">OnlineReplica</span>) <span class="comment">// 将Replica对象从NewReplica改为OnlineReplica状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Replica状态机"><a href="#Replica状态机" class="headerlink" title="Replica状态机"></a>Replica状态机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">七种状态</span><br><span class="line">NewReplica: The controller can create new replicas during partition reassignment. In this state, a replica can only get become follower state change request.  Valid previous state is NonExistentReplica</span><br><span class="line">OnlineReplica: Once a replica is started and part of the assigned replicas for its partition, it is in this state. In this state, it can get either become leader or become follower state change requests. Valid previous state are NewReplica, OnlineReplica or OfflineReplica</span><br><span class="line">OfflineReplica: If a replica dies, it moves to this state. This happens when the broker hosting the replica is down. Valid previous state are NewReplica, OnlineReplica</span><br><span class="line">ReplicaDeletionStarted: If replica deletion starts, it is moved to this state. Valid previous state is OfflineReplica</span><br><span class="line">ReplicaDeletionSuccessful: If replica responds with no error code in response to a delete replica request, it is moved to this state. Valid previous state is ReplicaDeletionStarted</span><br><span class="line">ReplicaDeletionIneligible: If replica deletion fails, it is moved to this state. Valid previous state is ReplicaDeletionStarted</span><br><span class="line">NonExistentReplica: If a replica is deleted successfully, it is moved to this state. Valid previous state is ReplicaDeletionSuccessful</span><br></pre></td></tr></table></figure>
<h3 id="Partition状态机"><a href="#Partition状态机" class="headerlink" title="Partition状态机"></a>Partition状态机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">四种状态</span><br><span class="line">NonExistentPartition: Partition不存在</span><br><span class="line">NewPartition: Partition刚创建,有对应的Replicas,但还没有Leader和ISR</span><br><span class="line">OnlinePartition: Partition的Leader已经选举出来了,处于正常的工作状态</span><br><span class="line">OfflinePartition: Partition的Leader挂了</span><br><span class="line"></span><br><span class="line">只有在OnlinePartition状态,才是可用状态</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="onNewPartitionCreation详细步骤"><a href="#onNewPartitionCreation详细步骤" class="headerlink" title="onNewPartitionCreation详细步骤"></a>onNewPartitionCreation详细步骤</h2><h3 id="changeStateTo方法"><a href="#changeStateTo方法" class="headerlink" title="changeStateTo方法"></a>changeStateTo方法</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">changeStateTo</span></span>(partition: <span class="type">TopicPartition</span>, currentState: <span class="type">PartitionState</span>, targetState: <span class="type">PartitionState</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  partitionState.put(partition, targetState) <span class="comment">// 缓存partition的状态</span></span><br><span class="line">  updateControllerMetrics(partition, currentState, targetState)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="partitionStateMachine-gt-NewPartition"><a href="#partitionStateMachine-gt-NewPartition" class="headerlink" title="partitionStateMachine-&gt;NewPartition"></a>partitionStateMachine-&gt;NewPartition</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">NewPartition</span> =&gt;</span><br><span class="line">    validPartitions.foreach &#123; partition =&gt;</span><br><span class="line">      stateChangeLog.trace(<span class="string">s&quot;Changed partition <span class="subst">$partition</span> state from <span class="subst">$&#123;partitionState(partition)&#125;</span> to <span class="subst">$targetState</span> with &quot;</span> +</span><br><span class="line">        <span class="string">s&quot;assigned replicas <span class="subst">$&#123;controllerContext.partitionReplicaAssignment(partition).mkString(&quot;,&quot;)&#125;</span>&quot;</span>)</span><br><span class="line">      changeStateTo(partition, partitionState(partition), <span class="type">NewPartition</span>) <span class="comment">// 将分区对象的状态置为NewPartition</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="replicaStateMachine-gt-NewReplica"><a href="#replicaStateMachine-gt-NewReplica" class="headerlink" title="replicaStateMachine-&gt;NewReplica"></a>replicaStateMachine-&gt;NewReplica</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">NewReplica</span> =&gt;</span><br><span class="line">  validReplicas.foreach &#123; replica =&gt;</span><br><span class="line">    <span class="keyword">val</span> partition = replica.topicPartition</span><br><span class="line">    controllerContext.partitionLeadershipInfo.get(partition) <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Some</span>(leaderIsrAndControllerEpoch) =&gt;</span><br><span class="line">        <span class="keyword">if</span> (leaderIsrAndControllerEpoch.leaderAndIsr.leader == replicaId) &#123; <span class="comment">// 这个状态的Replica不能作为Leader</span></span><br><span class="line">          <span class="keyword">val</span> exception = <span class="keyword">new</span> <span class="type">StateChangeFailedException</span>(<span class="string">s&quot;Replica <span class="subst">$replicaId</span> for partition <span class="subst">$partition</span> cannot be moved to NewReplica state as it is being requested to become leader&quot;</span>)</span><br><span class="line">          logFailedStateChange(replica, replicaState(replica), <span class="type">OfflineReplica</span>, exception)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 向所有replicaId发送LeaderAndIsr请求,这个方法同时也会向所有的Broker发送updateMeta请求</span></span><br><span class="line">          controllerBrokerRequestBatch.addLeaderAndIsrRequestForBrokers(<span class="type">Seq</span>(replicaId),</span><br><span class="line">            replica.topicPartition,</span><br><span class="line">            leaderIsrAndControllerEpoch,</span><br><span class="line">            controllerContext.partitionReplicaAssignment(replica.topicPartition),</span><br><span class="line">            isNew = <span class="literal">true</span>)</span><br><span class="line">          logSuccessfulTransition(replicaId, partition, replicaState(replica), <span class="type">NewReplica</span>)</span><br><span class="line">          replicaState.put(replica, <span class="type">NewReplica</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">        logSuccessfulTransition(replicaId, partition, replicaState(replica), <span class="type">NewReplica</span>)</span><br><span class="line">        replicaState.put(replica, <span class="type">NewReplica</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="partitionStateMachine-gt-OnlinePartition"><a href="#partitionStateMachine-gt-OnlinePartition" class="headerlink" title="partitionStateMachine-&gt;OnlinePartition"></a>partitionStateMachine-&gt;OnlinePartition</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">OnlinePartition</span> =&gt;</span><br><span class="line">    <span class="keyword">val</span> uninitializedPartitions = validPartitions.filter(partition =&gt; partitionState(partition) == <span class="type">NewPartition</span>)</span><br><span class="line">    <span class="keyword">val</span> partitionsToElectLeader = validPartitions.filter(partition =&gt; partitionState(partition) == <span class="type">OfflinePartition</span> || partitionState(partition) == <span class="type">OnlinePartition</span>)</span><br><span class="line">    <span class="keyword">if</span> (uninitializedPartitions.nonEmpty) &#123;</span><br><span class="line">      <span class="comment">// 为新建的Partition初始化Leader和Isr,选取Replica中第一个Replica作为Leader,所有的Replica作为ISR</span></span><br><span class="line">      <span class="comment">// 最后向所有replicaId发送LeaderAndIsr请求以及向所有的Broker发送updateMetadata请求</span></span><br><span class="line">      <span class="keyword">val</span> successfulInitializations = initializeLeaderAndIsrForPartitions(uninitializedPartitions)</span><br><span class="line">      successfulInitializations.foreach &#123; partition =&gt;</span><br><span class="line">        stateChangeLog.trace(<span class="string">s&quot;Changed partition <span class="subst">$partition</span> from <span class="subst">$&#123;partitionState(partition)&#125;</span> to <span class="subst">$targetState</span> with state &quot;</span> +</span><br><span class="line">          <span class="string">s&quot;<span class="subst">$&#123;controllerContext.partitionLeadershipInfo(partition).leaderAndIsr&#125;</span>&quot;</span>)</span><br><span class="line">        changeStateTo(partition, partitionState(partition), <span class="type">OnlinePartition</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (partitionsToElectLeader.nonEmpty) &#123;</span><br><span class="line">      <span class="keyword">val</span> successfulElections = electLeaderForPartitions(partitionsToElectLeader, partitionLeaderElectionStrategyOpt.get)</span><br><span class="line">      successfulElections.foreach &#123; partition =&gt;</span><br><span class="line">        stateChangeLog.trace(<span class="string">s&quot;Changed partition <span class="subst">$partition</span> from <span class="subst">$&#123;partitionState(partition)&#125;</span> to <span class="subst">$targetState</span> with state &quot;</span> +</span><br><span class="line">          <span class="string">s&quot;<span class="subst">$&#123;controllerContext.partitionLeadershipInfo(partition).leaderAndIsr&#125;</span>&quot;</span>)</span><br><span class="line">        changeStateTo(partition, partitionState(partition), <span class="type">OnlinePartition</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="replicaStateMachine-gt-OnlineReplica"><a href="#replicaStateMachine-gt-OnlineReplica" class="headerlink" title="replicaStateMachine-&gt;OnlineReplica"></a>replicaStateMachine-&gt;OnlineReplica</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">OnlineReplica</span> =&gt;</span><br><span class="line">  validReplicas.foreach &#123; replica =&gt;</span><br><span class="line">    <span class="keyword">val</span> partition = replica.topicPartition</span><br><span class="line">    replicaState(replica) <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">NewReplica</span> =&gt;</span><br><span class="line">        <span class="comment">// 向 the assigned replicas list 添加这个 replica(正常情况下这些 replicas 已经更新到 list 中了)</span></span><br><span class="line">        <span class="keyword">val</span> assignment = controllerContext.partitionReplicaAssignment(partition)</span><br><span class="line">        <span class="keyword">if</span> (!assignment.contains(replicaId)) &#123;</span><br><span class="line">          controllerContext.updatePartitionReplicaAssignment(partition, assignment :+ replicaId)</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">case</span> _ =&gt;</span><br><span class="line">        controllerContext.partitionLeadershipInfo.get(partition) <span class="keyword">match</span> &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="type">Some</span>(leaderIsrAndControllerEpoch) =&gt;</span><br><span class="line">            controllerBrokerRequestBatch.addLeaderAndIsrRequestForBrokers(<span class="type">Seq</span>(replicaId),</span><br><span class="line">              replica.topicPartition,</span><br><span class="line">              leaderIsrAndControllerEpoch,</span><br><span class="line">              controllerContext.partitionReplicaAssignment(partition), isNew = <span class="literal">false</span>)</span><br><span class="line">          <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    logSuccessfulTransition(replicaId, partition, replicaState(replica), <span class="type">OnlineReplica</span>)</span><br><span class="line">    replicaState.put(replica, <span class="type">OnlineReplica</span>)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huxi2b/p/5923252.html">如何创建Topic</a></p>

  </div>
  <footer class="article-footer">
    
  <div class="cc">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/deed.z" target="_blank" title="署名-相同方式共享">
      <img src="/images/cc/cc.png">
      
          <img src="/images/cc/by.png">
        
          <img src="/images/cc/sa.png">
      
      <span>
        本作品采用知识共享 署名-相同方式共享 4.0 国际许可协议进行许可。
      </span>
    </a>
  </div>


    

  </footer>
</article>







          <div class="main-footer">
  
    © 2021 BlackC - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  
<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>


  
<link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">

  
<link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">


  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  
<script src="/PhotoSwipe/photoswipe.js"></script>

  
<script src="/PhotoSwipe/photoswipe-ui-default.js"></script>




<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>


<script src="/scripts/main.js"></script>


</body>
</html>
