<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Flink源码解析之四ExecutionGraph生成
  
</title>

<meta name="description" content="介绍JobGraph被提交之后,JobManager如何接收到该请求,以及如何生成ExecutionGraph">
<meta name="keywords" content="flink">
<meta property="og:type" content="article">
<meta property="og:title" content="Flink源码解析之四ExecutionGraph生成">
<meta property="og:url" content="http://yoursite.com/2020/05/28/Flink源码解析之四ExecutionGraph生成/index.html">
<meta property="og:site_name" content="BlackC">
<meta property="og:description" content="介绍JobGraph被提交之后,JobManager如何接收到该请求,以及如何生成ExecutionGraph">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-05-28T08:09:11.687Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Flink源码解析之四ExecutionGraph生成">
<meta name="twitter:description" content="介绍JobGraph被提交之后,JobManager如何接收到该请求,以及如何生成ExecutionGraph">


  <link rel="alternative" href="/atom.xml" title="BlackC" type="application/atom+xml">



  <link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">






</head>
<body class="monochrome">
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">BlackC</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">BlackC</a></h1>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">X&amp;Z</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://raw.githubusercontent.com/jxeditor/Software/master/Blog/logo.jpg"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">分类</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">134</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/搭建/">搭建</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统/">系统</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编译/">编译</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编辑器/">编辑器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">10</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">标签</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cas/">cas</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cdh/">cdh</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edit/">edit</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elk/">elk</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink/">flink</a><span class="tag-list-count">77</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grafana/">grafana</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hbase/">hbase</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hive/">hive</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/">interview</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/">kafka</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kylin/">kylin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mr/">mr</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/neo4j/">neo4j</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/os/">os</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oss/">oss</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prometheus/">prometheus</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sbt/">sbt</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/">spark</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/">tools</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xwiki/">xwiki</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zk/">zk</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">归档</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">60</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">80</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a><span class="archive-list-count">18</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">10</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="主页">主页</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="文章">文章</a>
              </li>
            
          
            
              <li>
                <a href="/about" title="关于">关于</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/denjones/hexo-theme-chan" title="样式" target="_blank" rel="noopener">样式</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/jxeditor" title="Github" target="_blank" rel="noopener">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          <article id="post-Flink源码解析之四ExecutionGraph生成" class="article article-type-post">
  
    <h1 class="article-header">
      Flink源码解析之四ExecutionGraph生成
    </h1>
  
  

  <div class="article-info">
    <span class="article-date">
  2020-05-28
</span>

    
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/大数据/">大数据</a></li></ul>
	</span>


    
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flink/">flink</a></li></ul>
	</span>


  </div>
  <div class="article-entry">
    <blockquote>
<p>介绍JobGraph被提交之后,JobManager如何接收到该请求,以及如何生成ExecutionGraph</p>
</blockquote>
<a id="more"></a>
<h2 id="JobManager的启动"><a href="#JobManager的启动" class="headerlink" title="JobManager的启动"></a>JobManager的启动</h2><h3 id="JobSubmitHandler"><a href="#JobSubmitHandler" class="headerlink" title="JobSubmitHandler"></a>JobSubmitHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">此处理程序可用于将作业提交到Flink集群</span><br><span class="line">处理请求,调用submitJob,启动JobManagerRunner</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> CompletableFuture&lt;JobSubmitResponseBody&gt; <span class="title">handleRequest</span><span class="params">(@Nonnull HandlerRequest&lt;JobSubmitRequestBody, EmptyMessageParameters&gt; request, @Nonnull DispatcherGateway gateway)</span> <span class="keyword">throws</span> RestHandlerException </span>&#123;</span><br><span class="line">    <span class="comment">// 从request中获取上传的文件</span></span><br><span class="line">    <span class="keyword">final</span> Collection&lt;File&gt; uploadedFiles = request.getUploadedFiles();</span><br><span class="line">    <span class="comment">// 获取&lt;名称,文件路径&gt;</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, Path&gt; nameToFile = uploadedFiles.stream().collect(Collectors.toMap(</span><br><span class="line">        File::getName,</span><br><span class="line">        Path::fromLocalFile</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果上传文件数量与名称对应数量不匹配报错</span></span><br><span class="line">    <span class="keyword">if</span> (uploadedFiles.size() != nameToFile.size()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RestHandlerException(</span><br><span class="line">            String.format(<span class="string">"The number of uploaded files was %s than the expected count. Expected: %s Actual %s"</span>,</span><br><span class="line">                uploadedFiles.size() &lt; nameToFile.size() ? <span class="string">"lower"</span> : <span class="string">"higher"</span>,</span><br><span class="line">                nameToFile.size(),</span><br><span class="line">                uploadedFiles.size()),</span><br><span class="line">            HttpResponseStatus.BAD_REQUEST</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取请求体</span></span><br><span class="line">    <span class="keyword">final</span> JobSubmitRequestBody requestBody = request.getRequestBody();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (requestBody.jobGraphFileName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RestHandlerException(</span><br><span class="line">            String.format(<span class="string">"The %s field must not be omitted or be null."</span>,</span><br><span class="line">                JobSubmitRequestBody.FIELD_NAME_JOB_GRAPH),</span><br><span class="line">            HttpResponseStatus.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载JobGraph</span></span><br><span class="line">    CompletableFuture&lt;JobGraph&gt; jobGraphFuture = loadJobGraph(requestBody, nameToFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取Jar</span></span><br><span class="line">    Collection&lt;Path&gt; jarFiles = getJarFilesToUpload(requestBody.jarFileNames, nameToFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取artifacts</span></span><br><span class="line">    Collection&lt;Tuple2&lt;String, Path&gt;&gt; artifacts = getArtifactFilesToUpload(requestBody.artifactFileNames, nameToFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向BLOBServer上传信息</span></span><br><span class="line">    CompletableFuture&lt;JobGraph&gt; finalizedJobGraphFuture = uploadJobGraphFiles(gateway, jobGraphFuture, jarFiles, artifacts, configuration);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ack通信,向服务端提交任务</span></span><br><span class="line">    CompletableFuture&lt;Acknowledge&gt; jobSubmissionFuture = finalizedJobGraphFuture.thenCompose(jobGraph -&gt; gateway.submitJob(jobGraph, timeout));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jobSubmissionFuture.thenCombine(jobGraphFuture,</span><br><span class="line">        (ack, jobGraph) -&gt; <span class="keyword">new</span> JobSubmitResponseBody(<span class="string">"/jobs/"</span> + jobGraph.getJobID()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接下来依旧是Dispatcher中submitJob函数调用逻辑</span></span><br><span class="line"><span class="comment">// 详情可参考上一篇</span></span><br></pre></td></tr></table></figure>
<h3 id="JobManagerRunnerImpl"><a href="#JobManagerRunnerImpl" class="headerlink" title="JobManagerRunnerImpl"></a>JobManagerRunnerImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">了解一下JobManagerRunnerImpl内做了什么</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobManagerRunnerImpl</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> JobGraph jobGraph,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> JobMasterServiceFactory jobMasterFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> HighAvailabilityServices haServices,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> LibraryCacheManager libraryCacheManager,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Executor executor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> FatalErrorHandler fatalErrorHandler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.resultFuture = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line">    <span class="keyword">this</span>.terminationFuture = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line">    <span class="keyword">this</span>.leadershipOperation = CompletableFuture.completedFuture(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make sure we cleanly shut down out JobManager services if initialization fails</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.jobGraph = checkNotNull(jobGraph);</span><br><span class="line">        <span class="keyword">this</span>.libraryCacheManager = checkNotNull(libraryCacheManager);</span><br><span class="line">        <span class="keyword">this</span>.executor = checkNotNull(executor);</span><br><span class="line">        <span class="keyword">this</span>.fatalErrorHandler = checkNotNull(fatalErrorHandler);</span><br><span class="line"></span><br><span class="line">        checkArgument(jobGraph.getNumberOfVertices() &gt; <span class="number">0</span>, <span class="string">"The given job is empty"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// libraries and class loader first</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.向BlobLibraryCacheManager注册Job</span></span><br><span class="line">            libraryCacheManager.registerJob(</span><br><span class="line">                    jobGraph.getJobID(), jobGraph.getUserJarBlobKeys(), jobGraph.getClasspaths());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Cannot set up the user code libraries: "</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取类加载器</span></span><br><span class="line">        <span class="keyword">final</span> ClassLoader userCodeLoader = libraryCacheManager.getClassLoader(jobGraph.getJobID());</span><br><span class="line">        <span class="keyword">if</span> (userCodeLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The user code class loader could not be initialized."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// high availability services next</span></span><br><span class="line">        <span class="keyword">this</span>.runningJobsRegistry = haServices.getRunningJobsRegistry();</span><br><span class="line">        <span class="comment">// 为Job获取Leader选举服务</span></span><br><span class="line">        <span class="keyword">this</span>.leaderElectionService = haServices.getJobManagerLeaderElectionService(jobGraph.getJobID());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.leaderGatewayFuture = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// now start the JobManager</span></span><br><span class="line">        <span class="comment">// 启动JobMaster</span></span><br><span class="line">        <span class="keyword">this</span>.jobMasterService = jobMasterFactory.createJobMasterService(jobGraph, <span class="keyword">this</span>, userCodeLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        terminationFuture.completeExceptionally(t);</span><br><span class="line">        resultFuture.completeExceptionally(t);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobGraph.getJobID(), <span class="string">"Could not set up JobManager"</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ExecutionGroup的生成"><a href="#ExecutionGroup的生成" class="headerlink" title="ExecutionGroup的生成"></a>ExecutionGroup的生成</h2><h3 id="JobMaster"><a href="#JobMaster" class="headerlink" title="JobMaster"></a>JobMaster</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 入口DefaultJobMasterServiceFactory.createJobMasterService</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobMaster <span class="title">createJobMasterService</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        JobGraph jobGraph,</span></span></span><br><span class="line"><span class="function"><span class="params">        OnCompletionActions jobCompletionActions,</span></span></span><br><span class="line"><span class="function"><span class="params">        ClassLoader userCodeClassloader)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> JobMaster(</span><br><span class="line">    rpcService,</span><br><span class="line">    jobMasterConfiguration,</span><br><span class="line">    ResourceID.generate(),</span><br><span class="line">    jobGraph,</span><br><span class="line">    haServices,</span><br><span class="line">    slotPoolFactory,</span><br><span class="line">    schedulerFactory,</span><br><span class="line">    jobManagerSharedServices,</span><br><span class="line">    heartbeatServices,</span><br><span class="line">    jobManagerJobMetricGroupFactory,</span><br><span class="line">    jobCompletionActions,</span><br><span class="line">    fatalErrorHandler,</span><br><span class="line">    userCodeClassloader,</span><br><span class="line">    schedulerNGFactory,</span><br><span class="line">    shuffleMaster,</span><br><span class="line">    lookup -&gt; <span class="keyword">new</span> JobMasterPartitionTrackerImpl(</span><br><span class="line">        jobGraph.getJobID(),</span><br><span class="line">        shuffleMaster,</span><br><span class="line">        lookup</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JobMaster.createScheduler</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> SchedulerNG <span class="title">createScheduler</span><span class="params">(<span class="keyword">final</span> JobManagerJobMetricGroup jobManagerJobMetricGroup)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 创建SchedulerNG</span></span><br><span class="line">    <span class="keyword">return</span> schedulerNGFactory.createInstance(</span><br><span class="line">        log,</span><br><span class="line">        jobGraph,</span><br><span class="line">        backPressureStatsTracker,</span><br><span class="line">        scheduledExecutorService,</span><br><span class="line">        jobMasterConfiguration.getConfiguration(),</span><br><span class="line">        scheduler,</span><br><span class="line">        scheduledExecutorService,</span><br><span class="line">        userCodeLoader,</span><br><span class="line">        highAvailabilityServices.getCheckpointRecoveryFactory(),</span><br><span class="line">        rpcTimeout,</span><br><span class="line">        blobWriter,</span><br><span class="line">        jobManagerJobMetricGroup,</span><br><span class="line">        jobMasterConfiguration.getSlotRequestTimeout(),</span><br><span class="line">        shuffleMaster,</span><br><span class="line">        partitionTracker);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SchedulerNGFactory"><a href="#SchedulerNGFactory" class="headerlink" title="SchedulerNGFactory"></a>SchedulerNGFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">SchedulerNGFactory</span><br><span class="line">    DefaultSchedulerFactory</span><br><span class="line">    LegacySchedulerFactory</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分析DefaultSchedulerFactory</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SchedulerNG <span class="title">createInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Logger log,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> JobGraph jobGraph,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> BackPressureStatsTracker backPressureStatsTracker,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Executor ioExecutor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Configuration jobMasterConfiguration,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> SlotProvider slotProvider,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> ScheduledExecutorService futureExecutor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> ClassLoader userCodeLoader,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> CheckpointRecoveryFactory checkpointRecoveryFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Time rpcTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> BlobWriter blobWriter,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> JobManagerJobMetricGroup jobManagerJobMetricGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Time slotRequestTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> JobMasterPartitionTracker partitionTracker)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据JobGraph不同的调度模式获取SchedulingStrategyFactory</span></span><br><span class="line">    <span class="comment">// LAZY_FROM_SOURCES批处理</span></span><br><span class="line">    <span class="comment">// EAGER流处理</span></span><br><span class="line">    <span class="keyword">final</span> SchedulingStrategyFactory schedulingStrategyFactory = createSchedulingStrategyFactory(jobGraph.getScheduleMode());</span><br><span class="line">    <span class="comment">// 重启策略</span></span><br><span class="line">    <span class="keyword">final</span> RestartBackoffTimeStrategy restartBackoffTimeStrategy = RestartBackoffTimeStrategyFactoryLoader</span><br><span class="line">        .createRestartBackoffTimeStrategyFactory(</span><br><span class="line">            jobGraph</span><br><span class="line">                .getSerializedExecutionConfig()</span><br><span class="line">                .deserializeValue(userCodeLoader)</span><br><span class="line">                .getRestartStrategy(),</span><br><span class="line">            jobMasterConfiguration,</span><br><span class="line">            jobGraph.isCheckpointingEnabled())</span><br><span class="line">        .create();</span><br><span class="line">    log.info(<span class="string">"Using restart back off time strategy &#123;&#125; for &#123;&#125; (&#123;&#125;)."</span>, restartBackoffTimeStrategy, jobGraph.getName(), jobGraph.getJobID());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Slot分配策略</span></span><br><span class="line">    <span class="keyword">final</span> SlotProviderStrategy slotProviderStrategy = SlotProviderStrategy.from(</span><br><span class="line">        jobGraph.getScheduleMode(),</span><br><span class="line">        slotProvider,</span><br><span class="line">        slotRequestTimeout);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回DefaultScheduler</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultScheduler(</span><br><span class="line">        log,</span><br><span class="line">        jobGraph,</span><br><span class="line">        backPressureStatsTracker,</span><br><span class="line">        ioExecutor,</span><br><span class="line">        jobMasterConfiguration,</span><br><span class="line">        slotProvider,</span><br><span class="line">        futureExecutor,</span><br><span class="line">        <span class="keyword">new</span> ScheduledExecutorServiceAdapter(futureExecutor),</span><br><span class="line">        userCodeLoader,</span><br><span class="line">        checkpointRecoveryFactory,</span><br><span class="line">        rpcTimeout,</span><br><span class="line">        blobWriter,</span><br><span class="line">        jobManagerJobMetricGroup,</span><br><span class="line">        slotRequestTimeout,</span><br><span class="line">        shuffleMaster,</span><br><span class="line">        partitionTracker,</span><br><span class="line">        schedulingStrategyFactory,</span><br><span class="line">        FailoverStrategyFactoryLoader.loadFailoverStrategyFactory(jobMasterConfiguration),</span><br><span class="line">        restartBackoffTimeStrategy,</span><br><span class="line">        <span class="keyword">new</span> DefaultExecutionVertexOperations(),</span><br><span class="line">        <span class="keyword">new</span> ExecutionVertexVersioner(),</span><br><span class="line">        <span class="keyword">new</span> DefaultExecutionSlotAllocatorFactory(slotProviderStrategy));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DefaultScheduler-gt-SchedulerBase"><a href="#DefaultScheduler-gt-SchedulerBase" class="headerlink" title="DefaultScheduler-&gt;SchedulerBase"></a>DefaultScheduler-&gt;SchedulerBase</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">这里主要是分析其父类SchedulerBase</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.executionGraph = createAndRestoreExecutionGraph(jobManagerJobMetricGroup, checkNotNull(shuffleMaster), checkNotNull(partitionTracker));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建,恢复ExecutionGraph</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ExecutionGraph <span class="title">createAndRestoreExecutionGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		JobManagerJobMetricGroup currentJobManagerJobMetricGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">		ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="function"><span class="params">		JobMasterPartitionTracker partitionTracker)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 创建ExecutionGraph</span></span><br><span class="line">    ExecutionGraph newExecutionGraph = createExecutionGraph(currentJobManagerJobMetricGroup, shuffleMaster, partitionTracker);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> CheckpointCoordinator checkpointCoordinator = newExecutionGraph.getCheckpointCoordinator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (checkpointCoordinator != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// check whether we find a valid checkpoint</span></span><br><span class="line">        <span class="keyword">if</span> (!checkpointCoordinator.restoreLatestCheckpointedState(</span><br><span class="line">            <span class="keyword">new</span> HashSet&lt;&gt;(newExecutionGraph.getAllVertices().values()),</span><br><span class="line">            <span class="keyword">false</span>,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// check whether we can restore from a savepoint</span></span><br><span class="line">            tryRestoreExecutionGraphFromSavepoint(newExecutionGraph, jobGraph.getSavepointRestoreSettings());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newExecutionGraph;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ExecutionGraph <span class="title">createExecutionGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		JobManagerJobMetricGroup currentJobManagerJobMetricGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">		ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">final</span> JobMasterPartitionTracker partitionTracker)</span> <span class="keyword">throws</span> JobExecutionException, JobException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 失败策略</span></span><br><span class="line">    <span class="keyword">final</span> FailoverStrategy.Factory failoverStrategy = legacyScheduling ?</span><br><span class="line">        FailoverStrategyLoader.loadFailoverStrategy(jobMasterConfiguration, log) :</span><br><span class="line">        <span class="keyword">new</span> NoOpFailoverStrategy.Factory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// buildGraph初始化ExecutionGraphBuilder</span></span><br><span class="line">    <span class="keyword">return</span> ExecutionGraphBuilder.buildGraph(</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        jobGraph,</span><br><span class="line">        jobMasterConfiguration,</span><br><span class="line">        futureExecutor,</span><br><span class="line">        ioExecutor,</span><br><span class="line">        slotProvider,</span><br><span class="line">        userCodeLoader,</span><br><span class="line">        checkpointRecoveryFactory,</span><br><span class="line">        rpcTimeout,</span><br><span class="line">        restartStrategy,</span><br><span class="line">        currentJobManagerJobMetricGroup,</span><br><span class="line">        blobWriter,</span><br><span class="line">        slotRequestTimeout,</span><br><span class="line">        log,</span><br><span class="line">        shuffleMaster,</span><br><span class="line">        partitionTracker,</span><br><span class="line">        failoverStrategy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ExecutionGraphBuilder"><a href="#ExecutionGraphBuilder" class="headerlink" title="ExecutionGraphBuilder"></a>ExecutionGraphBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将JobGraph构建成ExecutionGraph</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutionGraph <span class="title">buildGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		@Nullable ExecutionGraph prior,</span></span></span><br><span class="line"><span class="function"><span class="params">		JobGraph jobGraph,</span></span></span><br><span class="line"><span class="function"><span class="params">		Configuration jobManagerConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">		ScheduledExecutorService futureExecutor,</span></span></span><br><span class="line"><span class="function"><span class="params">		Executor ioExecutor,</span></span></span><br><span class="line"><span class="function"><span class="params">		SlotProvider slotProvider,</span></span></span><br><span class="line"><span class="function"><span class="params">		ClassLoader classLoader,</span></span></span><br><span class="line"><span class="function"><span class="params">		CheckpointRecoveryFactory recoveryFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">		Time rpcTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">		RestartStrategy restartStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">		MetricGroup metrics,</span></span></span><br><span class="line"><span class="function"><span class="params">		BlobWriter blobWriter,</span></span></span><br><span class="line"><span class="function"><span class="params">		Time allocationTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">		Logger log,</span></span></span><br><span class="line"><span class="function"><span class="params">		ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="function"><span class="params">		JobMasterPartitionTracker partitionTracker,</span></span></span><br><span class="line"><span class="function"><span class="params">		FailoverStrategy.Factory failoverStrategyFactory)</span> <span class="keyword">throws</span> JobExecutionException, JobException </span>&#123;</span><br><span class="line"></span><br><span class="line">    checkNotNull(jobGraph, <span class="string">"job graph cannot be null"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String jobName = jobGraph.getName();</span><br><span class="line">    <span class="keyword">final</span> JobID jobId = jobGraph.getJobID();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Job信息</span></span><br><span class="line">    <span class="keyword">final</span> JobInformation jobInformation = <span class="keyword">new</span> JobInformation(</span><br><span class="line">        jobId,</span><br><span class="line">        jobName,</span><br><span class="line">        jobGraph.getSerializedExecutionConfig(),</span><br><span class="line">        jobGraph.getJobConfiguration(),</span><br><span class="line">        jobGraph.getUserJarBlobKeys(),</span><br><span class="line">        jobGraph.getClasspaths());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 历史记录中保留的先前执行尝试的最大次数。</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> maxPriorAttemptsHistoryLength =</span><br><span class="line">            jobManagerConfig.getInteger(JobManagerOptions.MAX_ATTEMPTS_HISTORY_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 中间结果分区</span></span><br><span class="line">    <span class="keyword">final</span> PartitionReleaseStrategy.Factory partitionReleaseStrategyFactory =</span><br><span class="line">        PartitionReleaseStrategyFactoryLoader.loadPartitionReleaseStrategyFactory(jobManagerConfig);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a new execution graph, if none exists so far</span></span><br><span class="line">    <span class="keyword">final</span> ExecutionGraph executionGraph;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建新的ExecutionGraph</span></span><br><span class="line">        executionGraph = (prior != <span class="keyword">null</span>) ? prior :</span><br><span class="line">            <span class="keyword">new</span> ExecutionGraph(</span><br><span class="line">                jobInformation,</span><br><span class="line">                futureExecutor,</span><br><span class="line">                ioExecutor,</span><br><span class="line">                rpcTimeout,</span><br><span class="line">                restartStrategy,</span><br><span class="line">                maxPriorAttemptsHistoryLength,</span><br><span class="line">                failoverStrategyFactory,</span><br><span class="line">                slotProvider,</span><br><span class="line">                classLoader,</span><br><span class="line">                blobWriter,</span><br><span class="line">                allocationTimeout,</span><br><span class="line">                partitionReleaseStrategyFactory,</span><br><span class="line">                shuffleMaster,</span><br><span class="line">                partitionTracker,</span><br><span class="line">                jobGraph.getScheduleMode());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Could not create the ExecutionGraph."</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set the basic properties</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 解析JobGraph生成Json形式的执行计划</span></span><br><span class="line">        executionGraph.setJsonPlan(JsonPlanGenerator.generatePlan(jobGraph));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        log.warn(<span class="string">"Cannot create JSON plan for job"</span>, t);</span><br><span class="line">        <span class="comment">// give the graph an empty plan</span></span><br><span class="line">        executionGraph.setJsonPlan(<span class="string">"&#123;&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize the vertices that have a master initialization hook</span></span><br><span class="line">    <span class="comment">// file output formats create directories here, input formats create splits</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> initMasterStart = System.nanoTime();</span><br><span class="line">    log.info(<span class="string">"Running initialization on master for job &#123;&#125; (&#123;&#125;)."</span>, jobName, jobId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取JobVertex,并在Master初始化</span></span><br><span class="line">    <span class="keyword">for</span> (JobVertex vertex : jobGraph.getVertices()) &#123;</span><br><span class="line">        String executableClass = vertex.getInvokableClassName();</span><br><span class="line">        <span class="keyword">if</span> (executableClass == <span class="keyword">null</span> || executableClass.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobSubmissionException(jobId,</span><br><span class="line">                    <span class="string">"The vertex "</span> + vertex.getID() + <span class="string">" ("</span> + vertex.getName() + <span class="string">") has no invokable class."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            vertex.initializeOnMaster(classLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId,</span><br><span class="line">                        <span class="string">"Cannot initialize task '"</span> + vertex.getName() + <span class="string">"': "</span> + t.getMessage(), t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"Successfully ran initialization on master in &#123;&#125; ms."</span>,</span><br><span class="line">            (System.nanoTime() - initMasterStart) / <span class="number">1_000_000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// topologically sort the job vertices and attach the graph to the existing one</span></span><br><span class="line">    <span class="comment">// 获取从Source开始排序完成的DAG拓扑</span></span><br><span class="line">    List&lt;JobVertex&gt; sortedTopology = jobGraph.getVerticesSortedTopologicallyFromSources();</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Adding &#123;&#125; vertices from job graph &#123;&#125; (&#123;&#125;)."</span>, sortedTopology.size(), jobName, jobId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将JobGraph转化为ExecutionGraph操作</span></span><br><span class="line">    executionGraph.attachJobGraph(sortedTopology);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Successfully created execution graph from job graph &#123;&#125; (&#123;&#125;)."</span>, jobName, jobId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// configure the state checkpointing</span></span><br><span class="line">    <span class="comment">// 配置CK</span></span><br><span class="line">    JobCheckpointingSettings snapshotSettings = jobGraph.getCheckpointingSettings();</span><br><span class="line">    <span class="keyword">if</span> (snapshotSettings != <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;ExecutionJobVertex&gt; triggerVertices =</span><br><span class="line">                idToVertex(snapshotSettings.getVerticesToTrigger(), executionGraph);</span><br><span class="line"></span><br><span class="line">        List&lt;ExecutionJobVertex&gt; ackVertices =</span><br><span class="line">                idToVertex(snapshotSettings.getVerticesToAcknowledge(), executionGraph);</span><br><span class="line"></span><br><span class="line">        List&lt;ExecutionJobVertex&gt; confirmVertices =</span><br><span class="line">                idToVertex(snapshotSettings.getVerticesToConfirm(), executionGraph);</span><br><span class="line"></span><br><span class="line">        CompletedCheckpointStore completedCheckpoints;</span><br><span class="line">        CheckpointIDCounter checkpointIdCounter;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> maxNumberOfCheckpointsToRetain = jobManagerConfig.getInteger(</span><br><span class="line">                    CheckpointingOptions.MAX_RETAINED_CHECKPOINTS);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (maxNumberOfCheckpointsToRetain &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// warning and use 1 as the default value if the setting in</span></span><br><span class="line">                <span class="comment">// state.checkpoints.max-retained-checkpoints is not greater than 0.</span></span><br><span class="line">                log.warn(<span class="string">"The setting for '&#123;&#125; : &#123;&#125;' is invalid. Using default value of &#123;&#125;"</span>,</span><br><span class="line">                        CheckpointingOptions.MAX_RETAINED_CHECKPOINTS.key(),</span><br><span class="line">                        maxNumberOfCheckpointsToRetain,</span><br><span class="line">                        CheckpointingOptions.MAX_RETAINED_CHECKPOINTS.defaultValue());</span><br><span class="line"></span><br><span class="line">                maxNumberOfCheckpointsToRetain = CheckpointingOptions.MAX_RETAINED_CHECKPOINTS.defaultValue();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            completedCheckpoints = recoveryFactory.createCheckpointStore(jobId, maxNumberOfCheckpointsToRetain, classLoader);</span><br><span class="line">            checkpointIdCounter = recoveryFactory.createCheckpointIDCounter(jobId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId, <span class="string">"Failed to initialize high-availability checkpoint handler"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Maximum number of remembered checkpoints</span></span><br><span class="line">        <span class="keyword">int</span> historySize = jobManagerConfig.getInteger(WebOptions.CHECKPOINTS_HISTORY_SIZE);</span><br><span class="line"></span><br><span class="line">        CheckpointStatsTracker checkpointStatsTracker = <span class="keyword">new</span> CheckpointStatsTracker(</span><br><span class="line">                historySize,</span><br><span class="line">                ackVertices,</span><br><span class="line">                snapshotSettings.getCheckpointCoordinatorConfiguration(),</span><br><span class="line">                metrics);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load the state backend from the application settings</span></span><br><span class="line">        <span class="keyword">final</span> StateBackend applicationConfiguredBackend;</span><br><span class="line">        <span class="keyword">final</span> SerializedValue&lt;StateBackend&gt; serializedAppConfigured = snapshotSettings.getDefaultStateBackend();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (serializedAppConfigured == <span class="keyword">null</span>) &#123;</span><br><span class="line">            applicationConfiguredBackend = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                applicationConfiguredBackend = serializedAppConfigured.deserializeValue(classLoader);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId,</span><br><span class="line">                        <span class="string">"Could not deserialize application-defined state backend."</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> StateBackend rootBackend;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rootBackend = StateBackendLoader.fromApplicationOrConfigOrDefault(</span><br><span class="line">                    applicationConfiguredBackend, jobManagerConfig, classLoader, log);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IllegalConfigurationException | IOException | DynamicCodeLoadingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId, <span class="string">"Could not instantiate configured state backend"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// instantiate the user-defined checkpoint hooks</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SerializedValue&lt;MasterTriggerRestoreHook.Factory[]&gt; serializedHooks = snapshotSettings.getMasterHooks();</span><br><span class="line">        <span class="keyword">final</span> List&lt;MasterTriggerRestoreHook&lt;?&gt;&gt; hooks;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (serializedHooks == <span class="keyword">null</span>) &#123;</span><br><span class="line">            hooks = Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> MasterTriggerRestoreHook.Factory[] hookFactories;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hookFactories = serializedHooks.deserializeValue(classLoader);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId, <span class="string">"Could not instantiate user-defined checkpoint hooks"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Thread thread = Thread.currentThread();</span><br><span class="line">            <span class="keyword">final</span> ClassLoader originalClassLoader = thread.getContextClassLoader();</span><br><span class="line">            thread.setContextClassLoader(classLoader);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hooks = <span class="keyword">new</span> ArrayList&lt;&gt;(hookFactories.length);</span><br><span class="line">                <span class="keyword">for</span> (MasterTriggerRestoreHook.Factory factory : hookFactories) &#123;</span><br><span class="line">                    hooks.add(MasterHooks.wrapHook(factory.create(), classLoader));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                thread.setContextClassLoader(originalClassLoader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> CheckpointCoordinatorConfiguration chkConfig = snapshotSettings.getCheckpointCoordinatorConfiguration();</span><br><span class="line"></span><br><span class="line">        executionGraph.enableCheckpointing(</span><br><span class="line">            chkConfig,</span><br><span class="line">            triggerVertices,</span><br><span class="line">            ackVertices,</span><br><span class="line">            confirmVertices,</span><br><span class="line">            hooks,</span><br><span class="line">            checkpointIdCounter,</span><br><span class="line">            completedCheckpoints,</span><br><span class="line">            rootBackend,</span><br><span class="line">            checkpointStatsTracker);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create all the metrics for the Execution Graph</span></span><br><span class="line">    <span class="comment">// 创建监控指标</span></span><br><span class="line">    metrics.gauge(RestartTimeGauge.METRIC_NAME, <span class="keyword">new</span> RestartTimeGauge(executionGraph));</span><br><span class="line">    metrics.gauge(DownTimeGauge.METRIC_NAME, <span class="keyword">new</span> DownTimeGauge(executionGraph));</span><br><span class="line">    metrics.gauge(UpTimeGauge.METRIC_NAME, <span class="keyword">new</span> UpTimeGauge(executionGraph));</span><br><span class="line">    <span class="comment">// 注册监控</span></span><br><span class="line">    executionGraph.getFailoverStrategy().registerMetrics(metrics);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> executionGraph;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attachJobGraph</span><span class="params">(List&lt;JobVertex&gt; topologiallySorted)</span> <span class="keyword">throws</span> JobException </span>&#123;</span><br><span class="line"></span><br><span class="line">    assertRunningInJobMasterMainThread();</span><br><span class="line"></span><br><span class="line">    LOG.debug(<span class="string">"Attaching &#123;&#125; topologically sorted vertices to existing job graph with &#123;&#125; "</span> +</span><br><span class="line">            <span class="string">"vertices and &#123;&#125; intermediate results."</span>,</span><br><span class="line">        topologiallySorted.size(),</span><br><span class="line">        tasks.size(),</span><br><span class="line">        intermediateResults.size());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;ExecutionJobVertex&gt; newExecJobVertices = <span class="keyword">new</span> ArrayList&lt;&gt;(topologiallySorted.size());</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> createTimestamp = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历JobVertex</span></span><br><span class="line">    <span class="keyword">for</span> (JobVertex jobVertex : topologiallySorted) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (jobVertex.isInputVertex() &amp;&amp; !jobVertex.isStoppable()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.isStoppable = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create the execution job vertex and attach it to the graph</span></span><br><span class="line">        ExecutionJobVertex ejv = <span class="keyword">new</span> ExecutionJobVertex(</span><br><span class="line">                <span class="keyword">this</span>,</span><br><span class="line">                jobVertex, <span class="comment">// JobVertex</span></span><br><span class="line">                <span class="number">1</span>, <span class="comment">// 并行度</span></span><br><span class="line">                maxPriorAttemptsHistoryLength, <span class="comment">// 历史记录中保留的先前执行尝试的最大次数</span></span><br><span class="line">                rpcTimeout, <span class="comment">// RPC通信的超时时间</span></span><br><span class="line">                globalModVersion, <span class="comment">// 全局恢复版本,每次全局恢复时都会递增</span></span><br><span class="line">                createTimestamp); <span class="comment">// 创建时间</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理JobEdge,对每个JobEdge,获取对应的intermediateResults,并记录到本节点的输入上</span></span><br><span class="line">        <span class="comment">// 最后把每个ExecutorVertex和对应的intermediateResults关联起来</span></span><br><span class="line">        ejv.connectToPredecessors(<span class="keyword">this</span>.intermediateResults);</span><br><span class="line"></span><br><span class="line">        ExecutionJobVertex previousTask = <span class="keyword">this</span>.tasks.putIfAbsent(jobVertex.getID(), ejv);</span><br><span class="line">        <span class="keyword">if</span> (previousTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobException(String.format(<span class="string">"Encountered two job vertices with ID %s : previous=[%s] / new=[%s]"</span>,</span><br><span class="line">                jobVertex.getID(), ejv, previousTask));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (IntermediateResult res : ejv.getProducedDataSets()) &#123;</span><br><span class="line">            IntermediateResult previousDataSet = <span class="keyword">this</span>.intermediateResults.putIfAbsent(res.getId(), res);</span><br><span class="line">            <span class="keyword">if</span> (previousDataSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JobException(String.format(<span class="string">"Encountered two intermediate data set with ID %s : previous=[%s] / new=[%s]"</span>,</span><br><span class="line">                    res.getId(), res, previousDataSet));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.verticesInCreationOrder.add(ejv);</span><br><span class="line">        <span class="keyword">this</span>.numVerticesTotal += ejv.getParallelism();</span><br><span class="line">        newExecJobVertices.add(ejv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the topology assigning should happen before notifying new vertices to failoverStrategy</span></span><br><span class="line">    executionTopology = <span class="keyword">new</span> DefaultExecutionTopology(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    failoverStrategy.notifyNewVertices(newExecJobVertices);</span><br><span class="line"></span><br><span class="line">    partitionReleaseStrategy = partitionReleaseStrategyFactory.createInstance(getSchedulingTopology());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </div>
  <footer class="article-footer">
    
  <div class="cc">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/deed.z" target="_blank" title="署名-相同方式共享">
      <img src="/images/cc/cc.png">
      
          <img src="/images/cc/by.png">
        
          <img src="/images/cc/sa.png">
      
      <span>
        本作品采用知识共享 署名-相同方式共享 4.0 国际许可协议进行许可。
      </span>
    </a>
  </div>


    

  </footer>
</article>







          <div class="main-footer">
  
    © 2020 BlackC - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

</body>
</html>
