<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    ES教程干货整理
  
</title>

<meta name="description" content="没有什么比官网更加详细了,传送门">
<meta name="keywords" content="elk">
<meta property="og:type" content="article">
<meta property="og:title" content="ES教程干货整理">
<meta property="og:url" content="http://yoursite.com/2018/07/05/ES教程干货整理/index.html">
<meta property="og:site_name" content="BlackC">
<meta property="og:description" content="没有什么比官网更加详细了,传送门">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-01-13T07:24:15.576Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ES教程干货整理">
<meta name="twitter:description" content="没有什么比官网更加详细了,传送门">


  <link rel="alternative" href="/atom.xml" title="BlackC" type="application/atom+xml">



  <link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">






</head>
<body class="monochrome">
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">BlackC</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">BlackC</a></h1>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">X&amp;Z</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1591944977169&amp;di=4920f7c74026501de2663d9c3d5a5f28&amp;imgtype=0&amp;src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201902%2F22%2F20190222143514_ujtyi.jpg"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">分类</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">146</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/搭建/">搭建</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统/">系统</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编译/">编译</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编辑器/">编辑器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">10</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">标签</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cas/">cas</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cdh/">cdh</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edit/">edit</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elk/">elk</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink/">flink</a><span class="tag-list-count">83</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink实际案例/">flink实际案例</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grafana/">grafana</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hbase/">hbase</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hive/">hive</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/">interview</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/">kafka</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kylin/">kylin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/learn/">learn</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mr/">mr</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/neo4j/">neo4j</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/os/">os</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oss/">oss</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prometheus/">prometheus</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sbt/">sbt</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/">spark</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/">tools</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xwiki/">xwiki</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zk/">zk</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">归档</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">73</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">80</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a><span class="archive-list-count">18</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">10</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="主页">主页</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="文章">文章</a>
              </li>
            
          
            
              <li>
                <a href="/about" title="关于">关于</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/denjones/hexo-theme-chan" title="样式" target="_blank" rel="noopener">样式</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/jxeditor" title="Github" target="_blank" rel="noopener">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          <article id="post-ES教程干货整理" class="article article-type-post">
  
    <h1 class="article-header">
      ES教程干货整理
    </h1>
  
  

  <div class="article-info">
    <span class="article-date">
  2018-07-05
</span>

    
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/大数据/">大数据</a></li></ul>
	</span>


    
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elk/">elk</a></li></ul>
	</span>


  </div>
  <div class="article-entry">
    <blockquote>
<p>没有什么比官网更加详细了,<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" target="_blank" rel="noopener">传送门</a></p>
</blockquote>
<a id="more"></a>

<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="Near-Realtime-NRT"><a href="#Near-Realtime-NRT" class="headerlink" title="Near Realtime (NRT)"></a>Near Realtime (NRT)</h3><p>在ES中进行搜索是近实时的,意思是数据从写入ES到可以被searchable仅仅需要1秒钟,因此说基于ES执行的搜索和分析可以达到秒级</p>
<h3 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h3><p>集群 , 集群是一个或多个node的集合,他们一起保存你存放进去的数据,用户可以在所有的node之间进行检索,一般的每个集群都会有一个唯一的名称标识,默认的名称标识为elasticsearch, 这个名字很重要,因为node想加入cluster时,需要这个名称信息</p>
<p>确保别在不同的环境中使用相同的集群名称,进而避免node加错集群的情况,一颗考虑下面的集群命名风格logging-stage和logging-dev和logging-pro</p>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>单台server就是一个node,他和cluster一样,也存在一个默认的名称,但是它的名称是通过UUID生成的随机串,当然用户也可以定制不同的名称,但是这个名字最好别重复,这个名称对于管理来说很在乎要,因为需要确定,当前网络中的哪台服务器,对应这个集群中的哪个节点</p>
<p>node存在一个默认的设置,默认的,当每一个node在启动时都会自动的去加入一个叫elasticsearch的节点,这就意味着,如果用户在网络中启动了多个node,他们会彼此发现,然后组成集群</p>
<p>在单个的cluster中,你可以拥有任意多的node,假如说你的网络上没有有其他正在运行的节点,然后你启动一个新的节点,这个新的节点自己会组件一个集群</p>
<h3 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h3><p>Index是一类拥有相似属性的document的集合,比如你可以为消费者的数据创建一个index,为产品创建一个index,为订单创建一个index</p>
<p>index名称(必须是小写的字符), 当需要对index中的文档执行索引,搜索,更新,删除,等操作时,都需要用到这个index</p>
<p>一个集群中理论上你可以创建任意数量的index</p>
<h3 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h3><p>Type可以作为index中的逻辑类别,为了更细的划分,比如用户数据type,评论数据type,博客数据type</p>
<p>在设计时,尽最大努力让拥有更多相同field的document会分为同一个type下</p>
<h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><p>document就是ES中存储的一条数据,就像mysql中的一行记录一样,可以是一条用户的记录,一个商品的记录等等</p>
<h3 id="Shards-amp-Replicas"><a href="#Shards-amp-Replicas" class="headerlink" title="Shards &amp; Replicas"></a>Shards &amp; Replicas</h3><p>elasticsearch6设置索引的默认分片数和副本数已经不是在elasticsearch.yml文件中了，而是使用了一个索引模板的东西。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 创建索引的时候设置</span><br><span class="line">PUT demo</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;index&quot; : &#123;</span><br><span class="line">            &quot;number_of_shards&quot; : 3, </span><br><span class="line">            &quot;number_of_replicas&quot; : 2 </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET demo</span><br><span class="line"> </span><br><span class="line"># 在创建Maping的时候设置</span><br><span class="line">PUT demo</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">        &quot;type1&quot; : &#123;</span><br><span class="line">            &quot;properties&quot; : &#123;</span><br><span class="line">                &quot;field1&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="入门探索"><a href="#入门探索" class="headerlink" title="入门探索"></a>入门探索</h2><h3 id="集群的健康状况"><a href="#集群的健康状况" class="headerlink" title="集群的健康状况"></a>集群的健康状况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/health?v</span><br><span class="line"></span><br><span class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1572595632 16:07:12  elasticsearch yellow          1         1      5   5    0    0        5             0                  -                 50.0%</span><br></pre></td></tr></table></figure>

<p>解读上面的信息,默认的集群名是elasticsearch,当前集群的status是yellow,后续列出来的是集群的分片信息,最后一个active_shards_percent表示当前集群中仅有一半shard是可用的</p>
<h3 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h3><p>存在三种状态分别是red green yellow</p>
<ul>
<li>green : 表示当前集群所有的节点全部可用</li>
<li>yellow: 表示所有的数据是可以访问的,但是并不是所有的replica shard都是可以使用的(我现在是默认启动一个node,而ES又不允许同一个node的primary shard和replica shard共存,因此我当前的node中仅仅存在5个primary shard,为status为黄色)</li>
<li>red: 集群宕机,数据不可访问</li>
</ul>
<h3 id="集群的索引信息"><a href="#集群的索引信息" class="headerlink" title="集群的索引信息"></a>集群的索引信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br><span class="line"></span><br><span class="line">health status index              uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">yellow open   ai_answer_question cl_oJNRPRV-bdBBBLLL05g   5   1     203459            0    172.3mb        172.3mb</span><br></pre></td></tr></table></figure>

<p>显示,状态yellow表示存在replica shard不可用, 存在5个primary shard,并且每一个primary shard都有一个replica shard , 一共20多万条文档,未删除过文档,文档占用的空间情况为172.3M</p>
<h3 id="创建index"><a href="#创建index" class="headerlink" title="创建index"></a>创建index</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /customer?pretty</span><br></pre></td></tr></table></figure>

<p>ES 使用的RestfulAPI,新增使用put,这是个很亲民的举动</p>
<h3 id="添加-or-修改"><a href="#添加-or-修改" class="headerlink" title="添加 or 修改"></a>添加 or 修改</h3><p><strong>如果是ES中没有过下面的数据则添加进去,如果存在了id=1的元素就修改(全量替换)</strong></p>
<ul>
<li>格式:<code>PUT /index/type/id</code></li>
</ul>
<blockquote>
<p><strong>全量替换时,原来的document是没有被删除的,而是被标记为deleted,被标记成的deleted是不会被检索出来的,当ES中数据越来越多时,才会删除它</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT /customer/_doc/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;John Doe&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 1,</span><br><span class="line">  &quot;result&quot;: &quot;created&quot;,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot;: 0,</span><br><span class="line">  &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>强制创建</strong>,加添_create或者?op_type=create</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUT /customer/_doc/1?op_type=create</span><br><span class="line">PUT /customer/_doc/1/_create</span><br></pre></td></tr></table></figure>

<ul>
<li>局部更新(Partial Update)</li>
</ul>
<blockquote>
<p><strong>不指定id则新增document</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /customer/_doc?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Jane Doe&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>指定id则进行doc的局部更新操作</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /customer/_doc/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Jane Doe&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>并且POST相对于上面的PUT而言,不论是否存在相同内容的doc,只要不指定id,都会使用一个随机的串当成id,完成doc的插入</strong></p>
</blockquote>
<blockquote>
<p><strong>Partial Update先获取document,再将传递过来的field更新进document的json中,将老的doc标记为deleted,再将创建document,相对于全量替换中间会省去两次网络请求</strong></p>
</blockquote>
<h3 id="检索"><a href="#检索" class="headerlink" title="检索"></a>检索</h3><p>格式: <code>GET /index/type/</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /customer/_doc/1?pretty</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 1,</span><br><span class="line">  &quot;found&quot;: true,</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;John Doe&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>删除一条document</p>
<blockquote>
<p><strong>大部分情况下,原来的document不会被立即删除,而是被标记为deleted,被标记成的deleted是不会被检索出来的,当ES中数据越来越多时,才会删除它</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DELETE /customer/_doc/1</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 2,</span><br><span class="line">  &quot;result&quot;: &quot;deleted&quot;,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot;: 1,</span><br><span class="line">  &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除index</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELETE /index1</span><br><span class="line">DELETE /index1,index2</span><br><span class="line">DELETE /index*</span><br><span class="line">DELETE /_all</span><br><span class="line"></span><br><span class="line"># 可以在elasticsearch.yml中将下面这个设置置为ture,表示禁止使用 DELETE /_all</span><br><span class="line">action.destructive_required_name:true</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h3><p>上面说了POST关键字,可以实现不指定id就完成document的插入, <code>POST</code> + <code>_update</code>关键字可以实现更新的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /customer/_doc/1/_update?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123; &quot;name&quot;: &quot;changwu&quot; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>POST+_update进行更新的动作依然需要执行id, 但是它相对于PUT来说,当使用POST进行更新时,id不存在的话会报错,而PUT则会认为这是在新增</strong></p>
</blockquote>
<p>此外: 针对这种更新操作,ES会先删除原来的doc,然后插入这个新的doc</p>
<hr>
<h2 id="document-api"><a href="#document-api" class="headerlink" title="document api"></a>document api</h2><h3 id="multi-index-amp-multi-type"><a href="#multi-index-amp-multi-type" class="headerlink" title="multi-index &amp; multi-type"></a>multi-index &amp; multi-type</h3><ul>
<li>检索所有索引下面的所有数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/_search</span><br></pre></td></tr></table></figure>

<ul>
<li>搜索指定索引下的所有数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index/_search</span><br></pre></td></tr></table></figure>

<ul>
<li>更多模式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/index1/index2/_search</span><br><span class="line">/*1/*2/_search</span><br><span class="line">/index1/index2/type1/type2/_search</span><br><span class="line">/_all/type1/type2/_search</span><br></pre></td></tr></table></figure>

<h3 id="mget-api-批量查询"><a href="#mget-api-批量查询" class="headerlink" title="_mget api 批量查询"></a>_mget api 批量查询</h3><ul>
<li>在docs中指定_index,_type,_id</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot; : &quot;test&quot;,</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;1&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot; : &quot;test&quot;,</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在URL中指定index</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;1&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在URL中指定 index和type</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /test/type/_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : &quot;1&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : &quot;2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在URL中指定index和type,并使用ids指定id范围</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /test/type/_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ids&quot; : [&quot;1&quot;, &quot;2&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>为不同的doc指定不同的过滤规则</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot; : &quot;test&quot;,</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">            &quot;_source&quot; : false</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot; : &quot;test&quot;,</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">            &quot;_source&quot; : [&quot;field3&quot;, &quot;field4&quot;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot; : &quot;test&quot;,</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">            &quot;_source&quot; : &#123;</span><br><span class="line">                &quot;include&quot;: [&quot;user&quot;],</span><br><span class="line">                &quot;exclude&quot;: [&quot;user.location&quot;]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bulk-api-批量增删改"><a href="#bulk-api-批量增删改" class="headerlink" title="_bulk api 批量增删改"></a>_bulk api 批量增删改</h3><h4 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;action&quot;:&#123;&quot;metadata&quot;&#125;&#125;\n</span><br><span class="line">&#123;&quot;data&quot;&#125;\n</span><br></pre></td></tr></table></figure>

<p>存在哪些类型的操作可以执行呢?</p>
<ul>
<li>delete: 删除文档</li>
<li>create: _create 强制创建</li>
<li>index: 表示普通的put操作,可以是创建文档也可以是全量替换文档</li>
<li>update: 局部替换</li>
</ul>
<p><strong>上面的语法中并不是人们习惯阅读的json格式,但是这种单行形式的json更具备高效的优势</strong></p>
<p>ES如何处理普通的json如下:</p>
<ul>
<li>将json数组转换为JSONArray对象,这就意味着内存中会出现一份一模一样的拷贝,一份是json文本,一份是JSONArray对象</li>
</ul>
<p>但是如果上面的单行JSON,ES直接进行切割使用,不会在内存中整一个数据拷贝出来</p>
<h4 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h4><p>delete比较好看仅仅需要一行json就ok</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;delete&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="create"><a href="#create" class="headerlink" title="create"></a>create</h4><p>两行json,第一行指明我们要创建的json的index,type以及id<br>第二行指明我们要创建的doc的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;create&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;field1&quot; : &quot;value3&quot; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="index"><a href="#index" class="headerlink" title="index"></a>index</h4><p>相当于是PUT,可以实现新建或者是全量替换,同样是两行json<br>第一行表示将要新建或者是全量替换的json的index type 以及 id<br>第二行是具体的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;field1&quot; : &quot;value1&quot; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="update"><a href="#update" class="headerlink" title="update"></a>update</h4><p>表示 parcial update,局部替换<br>他可以指定一个<code>retry_on_conflict</code>的特性,表示可以重试3次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123; &quot;update&quot; : &#123;&quot;_id&quot; : &quot;1&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_index&quot; : &quot;index1&quot;, &quot;retry_on_conflict&quot; : 3&#125; &#125;</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;field&quot; : &quot;value&quot;&#125; &#125;</span><br><span class="line">&#123; &quot;update&quot; : &#123; &quot;_id&quot; : &quot;0&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_index&quot; : &quot;index1&quot;, &quot;retry_on_conflict&quot; : 3&#125; &#125;</span><br><span class="line">&#123; &quot;script&quot; : &#123; &quot;source&quot;: &quot;ctx._source.counter += params.param1&quot;, &quot;lang&quot; : &quot;painless&quot;, &quot;params&quot; : &#123;&quot;param1&quot; : 1&#125;&#125;, &quot;upsert&quot; : &#123;&quot;counter&quot; : 1&#125;&#125;</span><br><span class="line">&#123; &quot;update&quot; : &#123;&quot;_id&quot; : &quot;2&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_index&quot; : &quot;index1&quot;, &quot;retry_on_conflict&quot; : 3&#125; &#125;</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;field&quot; : &quot;value&quot;&#125;, &quot;doc_as_upsert&quot; : true &#125;</span><br><span class="line">&#123; &quot;update&quot; : &#123;&quot;_id&quot; : &quot;3&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_index&quot; : &quot;index1&quot;, &quot;_source&quot; : true&#125; &#125;</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;field&quot; : &quot;value&quot;&#125; &#125;</span><br><span class="line">&#123; &quot;update&quot; : &#123;&quot;_id&quot; : &quot;4&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_index&quot; : &quot;index1&quot;&#125; &#125;</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;field&quot; : &quot;value&quot;&#125;, &quot;_source&quot;: true&#125;</span><br></pre></td></tr></table></figure>

<h3 id="滚动查询技术"><a href="#滚动查询技术" class="headerlink" title="滚动查询技术"></a>滚动查询技术</h3><p>滚动查询技术和分页技术在使用场景方面还是存在出入的,这里的滚动查询技术同样适用于系统在海量数据中进行检索,比如过一次性存在10条数据被命中可以被检索出来,那么性能一定会很差,这时可以选择使用滚动查询技术,一批一批的查询,直到所有的数据被查询完成他可以先搜索一批数据再搜索一批数据</p>
<p>采用基于_doc的排序方式会获得较高的性能</p>
<p>每次发送scroll请求,我们还需要指定一个scroll参数,指定一个时间窗口,每次搜索只要在这个时间窗口内完成就ok</p>
<p>示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">GET /index/type/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match_all&quot;:&#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;:[&quot;_doc&quot;],</span><br><span class="line">    &quot;size&quot;:3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_scroll_id&quot;: &quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAACNFlJmWHZLTkFhU0plbzlHX01LU2VzUXcAAAAAAAAAkRZSZlh2S05BYVNKZW85R19NS1Nlc1F3AAAAAAAAAI8WUmZYdktOQWFTSmVvOUdfTUtTZXNRdwAAAAAAAACQFlJmWHZLTkFhU0plbzlHX01LU2VzUXcAAAAAAAAAjhZSZlh2S05BYVNKZW85R19NS1Nlc1F3&quot;,</span><br><span class="line">  &quot;took&quot;: 9,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;max_score&quot;: null,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;my_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot;: null,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;This is another document&quot;,</span><br><span class="line">          &quot;body&quot;: &quot;This document has a body&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sort&quot;: [</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;my_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: null,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;This is a document&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sort&quot;: [</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次滚动查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    &quot;scroll&quot;:&quot;1m&quot;,</span><br><span class="line">    &quot;_scroll_id&quot;: &quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAACNFlJmWHZLTkFhU0plbzlHX01LU2VzUXcAAAAAAAAAkRZSZlh2S05BYVNKZW85R19NS1Nlc1F3AAAAAAAAAI8WUmZYdktOQWFTSmVvOUdfTUtTZXNRdwAAAAAAAACQFlJmWHZLTkFhU0plbzlHX01LU2VzUXcAAAAAAAAAjhZSZlh2S05BYVNKZW85R19NS1Nlc1F3&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="search-api-搜索api"><a href="#search-api-搜索api" class="headerlink" title="_search api 搜索api"></a>_search api 搜索api</h2><h3 id="query-string-search"><a href="#query-string-search" class="headerlink" title="query string search"></a>query string search</h3><p><code>_search</code>API + 将请求写在URI中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search?q=*&amp;sort=account_number:asc&amp;pretty</span><br></pre></td></tr></table></figure>

<p>同样使用的是RestfulAPI, <code>q=*</code> ,表示匹配index=bank的下的所有doc,<code>sort=account_number:asc</code>表示告诉ES,结果按照account_number字段升序排序,<code>pretty</code>是告诉ES,返回一个漂亮的json格式的数据</p>
<p>上面的q还可以写成下面这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search?q=自定义field:期望的值</span><br><span class="line">GET /bank/_search?q=+自定义field:期望的值</span><br><span class="line">GET /bank/_search?q=-自定义field:期望的值</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 63,    // 耗费的时间</span><br><span class="line">  &quot;timed_out&quot; : false,  // 是否超时了</span><br><span class="line">  &quot;_shards&quot; : &#123;   // 分片信息</span><br><span class="line">    &quot;total&quot; : 5, // 总共5个分片,它的搜索请求会被打到5个分片上去,并且都成功了</span><br><span class="line">    &quot;successful&quot; : 5,  // </span><br><span class="line">    &quot;skipped&quot; : 0, // 跳过了0个</span><br><span class="line">    &quot;failed&quot; : 0 // 失败了0个</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;  //命中的情况</span><br><span class="line">    &quot;total&quot; : 1000,  // 命中率 1000个</span><br><span class="line">    &quot;max_score&quot; : null,  // 相关性得分,越相关就越匹配</span><br><span class="line">    &quot;hits&quot; : [ &#123;   </span><br><span class="line">      &quot;_index&quot; : &quot;bank&quot;,  // 索引</span><br><span class="line">      &quot;_type&quot; : &quot;_doc&quot;,   // type</span><br><span class="line">      &quot;_id&quot; : &quot;0&quot;,  // id </span><br><span class="line">      &quot;sort&quot;: [0], </span><br><span class="line">      &quot;_score&quot; : null, // 相关性得分</span><br><span class="line">                    // _source里面存放的是数据</span><br><span class="line">      &quot;_source&quot; : &#123;&quot;account_number&quot;:0,&quot;balance&quot;:16623,&quot;firstname&quot;:&quot;Bradshaw&quot;,&quot;lastname&quot;:&quot;Mckenzie&quot;,&quot;age&quot;:29,&quot;gender&quot;:&quot;F&quot;,&quot;address&quot;:&quot;244 Columbus Place&quot;,&quot;employer&quot;:&quot;Euron&quot;,&quot;email&quot;:&quot;bradshawmckenzie@euron.com&quot;,&quot;city&quot;:&quot;Hobucken&quot;,&quot;state&quot;:&quot;CO&quot;&#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      &quot;_index&quot; : &quot;bank&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">      &quot;sort&quot;: [1],</span><br><span class="line">      &quot;_score&quot; : null,</span><br><span class="line">      &quot;_source&quot; : &#123;&quot;account_number&quot;:1,&quot;balance&quot;:39225,&quot;firstname&quot;:&quot;Amber&quot;,&quot;lastname&quot;:&quot;Duke&quot;,&quot;age&quot;:32,&quot;gender&quot;:&quot;M&quot;,&quot;address&quot;:&quot;880 Holmes Lane&quot;,&quot;employer&quot;:&quot;Pyrami&quot;,&quot;email&quot;:&quot;amberduke@pyrami.com&quot;,&quot;city&quot;:&quot;Brogan&quot;,&quot;state&quot;:&quot;IL&quot;&#125;</span><br><span class="line">    &#125;, ...</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指定超时时间: <code>GET /_search?timeout=10ms</code> 在进行优化时,可以考虑使用timeout, 比如: 正常来说我们可以在10s内获取2000条数据,但是指定了timeout,发生超时后我们可以获取10ms中获取到的 100条数据</p>
<h3 id="query-dsl-domain-specified-language"><a href="#query-dsl-domain-specified-language" class="headerlink" title="query dsl (domain specified language)"></a>query dsl (domain specified language)</h3><p>参见官网 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" target="_blank" rel="noopener">点击进入官网</a><br><code>_search</code>API +将请求写在请求体中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;, # 查询全部</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match&quot;: &#123;&quot;name&quot;:&quot;changwu zhu&quot;&#125; &#125;, # 全文检索,户将输入的字符串拆解开,去倒排索引中一一匹配, 哪怕匹配上了一个也会将结果返回</span><br><span class="line">  # 实际上,上面的操作会被ES转换成下面的格式</span><br><span class="line">  #</span><br><span class="line">  # &#123;</span><br><span class="line">  #    &quot;bool&quot;:&#123;</span><br><span class="line">  #        &quot;should&quot;:[</span><br><span class="line">  #         &#123;&quot;term&quot;:&#123;&quot;title&quot;:&quot;changwu&quot;&#125;&#125;,</span><br><span class="line">  #         &#123;&quot;term&quot;:&#123;&quot;title&quot;:&quot;zhu&quot;&#125;&#125;</span><br><span class="line">  #     ]</span><br><span class="line">  #  &#125;</span><br><span class="line">  # &#125;</span><br><span class="line">  #</span><br><span class="line">   &quot;query&quot;: &#123; </span><br><span class="line">     &quot;match&quot;: &#123; # 手动控制全文检索的精度,</span><br><span class="line">        &quot;name&quot;:&#123;</span><br><span class="line">            &quot;query&quot;:&quot;changwu zhu&quot;,</span><br><span class="line">            &quot;operator&quot;:&quot;and&quot;,  # and表示,只有同时出现changwu zhu 两个词的doc才会被命中</span><br><span class="line">            &quot;minimum_should_match&quot;:&quot;75%&quot; # 去长尾,控制至少命中3/4才算是真正命中</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;, # 全文检索,operator 表示</span><br><span class="line">  # 添加上operator 操作会被ES转换成下面的格式,将上面的should转换成must</span><br><span class="line">  #</span><br><span class="line">  # &#123;</span><br><span class="line">  #    &quot;bool&quot;:&#123;</span><br><span class="line">  #        &quot;must&quot;:[</span><br><span class="line">  #         &#123;&quot;term&quot;:&#123;&quot;title&quot;:&quot;changwu&quot;&#125;&#125;,</span><br><span class="line">  #         &#123;&quot;term&quot;:&#123;&quot;title&quot;:&quot;zhu&quot;&#125;&#125;</span><br><span class="line">  #     ]</span><br><span class="line">  #  &#125;</span><br><span class="line">  # &#125;</span><br><span class="line">  #</span><br><span class="line">  # 添加上 minimum_should_match 操作会被ES转换成下面的格式 </span><br><span class="line">  #</span><br><span class="line">  # &#123;</span><br><span class="line">  #    &quot;bool&quot;:&#123;</span><br><span class="line">  #        &quot;should&quot;:[</span><br><span class="line">  #         &#123;&quot;term&quot;:&#123;&quot;title&quot;:&quot;changwu&quot;&#125;&#125;,</span><br><span class="line">  #         &#123;&quot;term&quot;:&#123;&quot;title&quot;:&quot;zhu&quot;&#125;&#125;</span><br><span class="line">  #     ],</span><br><span class="line">  #       &quot;minimum_should_match&quot;:3</span><br><span class="line">  #  &#125;</span><br><span class="line">  # &#125;</span><br><span class="line">  #  </span><br><span class="line">   &quot;query&quot;: &#123; </span><br><span class="line">     &quot;match&quot;: &#123; #控制权重, </span><br><span class="line">        &quot;name&quot;:&#123;</span><br><span class="line">            &quot;query&quot;:&quot;changwu zhu&quot;,</span><br><span class="line">            &quot;boost&quot;:3  # 将name字段的权重提升成3,默认情况下,所有字段的权重都是样的,都是1</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">   &quot;query&quot;: &#123; </span><br><span class="line">   # 这种用法不容忽略</span><br><span class="line">     &quot;dis_max&quot;: &#123; # 直接取下面多个query中得分最高的query当成最终得分</span><br><span class="line">        &quot;queries&quot;:[</span><br><span class="line">           &#123;&quot;match&quot;:&#123;&quot;name&quot;:&quot;changwu zhu&quot;&#125;&#125;,</span><br><span class="line">           &#123;&quot;match&quot;:&#123;&quot;content&quot;:&quot;changwu&quot;&#125;&#125;</span><br><span class="line">        ]</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    # best field策略</span><br><span class="line">    &quot;query&quot;: &#123; # 基于 tie_breaker 优化dis_max</span><br><span class="line">    # tie_breaker可以使dis_max考虑其他field的得分影响</span><br><span class="line">       &quot;multi_match&quot;:&#123;</span><br><span class="line">           &quot;query&quot;:&quot;用于去匹配的字段&quot;,</span><br><span class="line">           &quot;type&quot;:&quot;most_fields&quot;,# 指定检索的策略most_fields</span><br><span class="line">           &quot;fields&quot;:[&quot;field1&quot;,&quot;field2&quot;,&quot;field3&quot;]</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    # most field 策略, 优先返回命中更多关键词的doc, (忽略从哪个,从多少个field中命中的,只要命中就行)</span><br><span class="line">    &quot;query&quot;: &#123; # 基于 tie_breaker 优化dis_max</span><br><span class="line">    # tie_breaker可以使dis_max考虑其他field的得分影响</span><br><span class="line">     &quot;dis_max&quot;: &#123; # 直接取下面多个query中得分最高的query当成最终得分, 这也是best field策略</span><br><span class="line">        &quot;queries&quot;:[</span><br><span class="line">           &#123;&quot;match&quot;:&#123;&quot;name&quot;:&quot;changwu zhu&quot;&#125;&#125;,</span><br><span class="line">           &#123;&quot;match&quot;:&#123;&quot;content&quot;:&quot;changwu&quot;&#125;&#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;tie_breaker&quot;:0.4</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_none&quot;: &#123;&#125; &#125;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;term&quot;: &#123;&quot;test_field&quot;:&quot;指定值&quot;&#125; &#125; # 精确匹配</span><br><span class="line">  &quot;query&quot;: &#123; &quot;exits&quot;: &#123;&quot;field&quot;:&quot;title&quot;&#125; &#125; # title不为空(但是这时ES2.0中的用法,现在不再提供了)</span><br><span class="line">  &quot;query&quot;: &#123;  # 短语检索 </span><br><span class="line">              # 顺序的保证是通过 term position来保证的</span><br><span class="line">              # 精准度很高,但是召回率低</span><br><span class="line">         &quot;match_phrase&quot;: &#123; # 只有address字段中包含了完整的 mill lane (相连,顺序也不能变) 时,这个doc才算命中</span><br><span class="line">             &quot;address&quot;: &quot;mill lane&quot;</span><br><span class="line">             &#125; </span><br><span class="line">  &#125;,</span><br><span class="line">   &quot;query&quot;: &#123;  # 短语检索 </span><br><span class="line">         &quot;match_phrase&quot;: &#123; </span><br><span class="line">             &quot;address&quot;: &quot;mill lane&quot;,</span><br><span class="line">             # 指定了slop就不再要求搜索term之间必须相邻,而是可以最多间隔slop距离</span><br><span class="line">             # 在指定了slop参数的情况下,离关键词越近,移动的次数越少, relevance score 越高</span><br><span class="line">             # match_phrase +  slop 和 proximity match 近似匹配作用类似</span><br><span class="line">             # 平衡精准度和召回率</span><br><span class="line">             &quot;slop&quot;:1 # 指定搜索文本中的几个term经过几次移动后可以匹配到一个doc</span><br><span class="line">             &#125; </span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  # 混合使用match和match_phrase 平衡精准度和召回率</span><br><span class="line">   &quot;query&quot;: &#123; </span><br><span class="line">      &quot;bool&quot;: &#123;  </span><br><span class="line">      &quot;must&quot;:  &#123;</span><br><span class="line">          # 全文检索虽然可以匹配到大量的文档,但是它不能控制词条之间的距离</span><br><span class="line">          # 可能java elasticsearch在Adoc中距离很近,但是它却被ES排在结果集的后面</span><br><span class="line">          # 它的性能比match_phrase高10倍,比proximity高20倍</span><br><span class="line">         &quot;match&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &quot;java elasticsearch&quot; </span><br><span class="line">            &#125; </span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;should&quot;: &#123;</span><br><span class="line">         # 借助match_phrase+slop可以感知term position的功能,为距离相近的doc贡献分数,让它们靠前排列</span><br><span class="line">          &quot;match_phrase&quot;:&#123;</span><br><span class="line">              &quot;title&quot;:&#123;</span><br><span class="line">                  &quot;query&quot;:&quot;java elasticsearch&quot;,</span><br><span class="line">                  &quot;slop&quot;:50</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  # 重打分机制</span><br><span class="line">   &quot;query&quot;: &#123; </span><br><span class="line">       &quot;match&quot;:&#123;</span><br><span class="line">           &quot;title&quot;:&#123;</span><br><span class="line">               &quot;query&quot;:&quot;java elasticsearch&quot;,</span><br><span class="line">               &quot;minimum_should_match&quot;:&quot;50%&quot;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">       &quot;rescore&quot;:&#123; # 对全文检索的结果进行重新打分</span><br><span class="line">           &quot;window_size&quot;:50,  # 对全文检索的前50条进行重新打分</span><br><span class="line">           &quot;query&quot;: &#123; </span><br><span class="line">               &quot;rescore_query&quot;:&#123; # 关键字</span><br><span class="line">                    &quot;match_phrase&quot;:&#123; # match_phrase + slop 感知 term persition,贡献分数</span><br><span class="line">                       &quot;title&quot;:&#123;</span><br><span class="line">                           &quot;query&quot;:&quot;java elasticsearch&quot;,</span><br><span class="line">                           &quot;slop&quot;:50</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">  # 前缀匹配, 相对于全文检索,前缀匹配是不会进行分词的,而且每次匹配都会扫描整个倒排索引,直到扫描完一遍才会停下来</span><br><span class="line">  # 不会计算相关性得分,前缀越短拼配到的越多,性能越不好</span><br><span class="line">  &quot;query&quot;: &#123; # 查询多个, 在下面指定的两个字段中检索含有 `this is a test`的doc</span><br><span class="line">    &quot;multi_match&quot; : &#123;</span><br><span class="line">      &quot;query&quot;:    &quot;this is a test&quot;, </span><br><span class="line">      &quot;fields&quot;: [ &quot;subject&quot;, &quot;message&quot; ] </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;query&quot;: &#123; # 前缀搜索,搜索 user字段以ki开头的 doc</span><br><span class="line">    &quot;prefix&quot; : &#123; &quot;user&quot; : &quot;ki&quot; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;query&quot;: &#123; # 前缀搜索 + 添加权重</span><br><span class="line">    &quot;prefix&quot; : &#123; &quot;user&quot; :  &#123; &quot;value&quot; : &quot;ki&quot;, &quot;boost&quot; : 2.0 &#125; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  # 通配符搜索</span><br><span class="line">   &quot;query&quot;: &#123;</span><br><span class="line">        &quot;wildcard&quot; : &#123; &quot;user&quot; : &quot;ki*y&quot; &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">   &quot;query&quot;: &#123;</span><br><span class="line">        &quot;wildcard&quot; : &#123; &quot;user&quot; : &#123; &quot;value&quot; : &quot;ki*y&quot;, &quot;boost&quot; : 2.0 &#125; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  # 正则搜索</span><br><span class="line">   &quot;query&quot;: &#123;</span><br><span class="line">        &quot;regexp&quot;:&#123;</span><br><span class="line">            &quot;name.first&quot;: &quot;s.*y&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">   &quot;query&quot;: &#123;# 正则搜索</span><br><span class="line">        &quot;regexp&quot;:&#123;</span><br><span class="line">            &quot;name.first&quot;:&#123;</span><br><span class="line">                &quot;value&quot;:&quot;s.*y&quot;,</span><br><span class="line">                &quot;boost&quot;:1.2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  # 搜索推荐, 类似于百度,当用户输入一个词条后,将其他符合条件的词条的选项推送出来</span><br><span class="line">  # 原理和match_pharse相似,但是唯一的区别就是会将最后一个term当作前缀去搜索</span><br><span class="line">  # 下例中: 使用quick brown进行match 使用f进行前缀搜索,使用slop调整term persition,贡献得分</span><br><span class="line">   &quot;query&quot;: &#123;</span><br><span class="line">      &quot;match_phrase_prefix&quot; : &#123;# 前缀匹配</span><br><span class="line">        &quot;message&quot; : &#123;</span><br><span class="line">                &quot;query&quot; : &quot;quick brown f&quot;,</span><br><span class="line">                &quot;max_expansions&quot; : 10, # 指定前缀最多匹配多少个term,超过这个数量就不在倒排索引中检索了,提升性能</span><br><span class="line">                &quot;slop&quot;:10</span><br><span class="line">            &#125;</span><br><span class="line">       &#125; </span><br><span class="line">  &#125;,</span><br><span class="line">  # Function Score Query</span><br><span class="line">  # 用户可以自定义一个function_secore 函数,然后将某个field的值和ES计算出来的分数进行运算</span><br><span class="line">  # 最终实现对自己指定的field进行分数的增强功能</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">        &quot;function_score&quot;: &#123;</span><br><span class="line">            &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">            &quot;boost&quot;: &quot;5&quot;,</span><br><span class="line">            &quot;random_score&quot;: &#123;&#125;, </span><br><span class="line">            &quot;boost_mode&quot;:&quot;multiply&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">  </span><br><span class="line">  # Fuzzy Query 模糊查询会提供容错的处理</span><br><span class="line">   &quot;query&quot;: &#123;</span><br><span class="line">        &quot;fuzzy&quot; : &#123;</span><br><span class="line">            &quot;user&quot; : &#123;</span><br><span class="line">                &quot;value&quot;: &quot;ki&quot;,</span><br><span class="line">                &quot;boost&quot;: 1.0,</span><br><span class="line">                &quot;fuzziness&quot;: 2, # 做大的纠错数量</span><br><span class="line">                &quot;prefix_length&quot;: 0,# 不会被“模糊化”的初始字符数。这有助于减少必须检查的术语的数量。默认值为0。</span><br><span class="line">                &quot;max_expansions&quot;: 100 # 模糊查询将扩展到的最大项数。默认值为50</span><br><span class="line">                transpositions:true # 是否支持模糊变换(ab→ba)。默认的是假的</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;  # 布尔查询, 最终通过将它内置must,should等查询的得分加起来/should,must的总数, 得到最终的得分</span><br><span class="line">      &quot;must&quot;: [ # 必须匹配到XXX, 并且会得出相关性得分</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;mill&quot; &#125; &#125;, # address中必须包含mill</span><br><span class="line">      ],</span><br><span class="line">      # 在满足must的基础上,should条件不满足也可以,但是如果也匹配上了,相关性得分会增加</span><br><span class="line">      # 如果没有must的话,should中的条件必须满足一个</span><br><span class="line">      &quot;should&quot;: [ # 指定可以包含的值, should是可以影响相关性得分的</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;lane&quot; &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [ # 一定不包含谁</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;mill&quot; &#125; &#125;,</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: &#123; # 对数据进行过滤</span><br><span class="line">        &quot;range&quot;: &#123; # 按照范围过滤</span><br><span class="line">          &quot;balance&quot;: &#123; # 指定过滤的字段</span><br><span class="line">            &quot;gte&quot;: 20000, # 高于20000</span><br><span class="line">            &quot;lte&quot;: 30000  # 低于30000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>在上面的组合查询中,每一个子查询都会计算一下他的相关性分数,然后由最外层的bool综合合并一个得分,但是 filter是不会计算分数的</strong></p>
</blockquote>
<blockquote>
<p><strong>默认的排序规则是按照score降序排序,但像上面说的那样,如果全部都是filter的话他就不会计算得分,也就是说所有的得分全是1,这时候就需要定制排序规则,定义的语法我在上面写了</strong></p>
</blockquote>
<h3 id="其他辅助API"><a href="#其他辅助API" class="headerlink" title="其他辅助API"></a>其他辅助API</h3><p>比如下面的高亮,排序,分页,以及<code>_source</code>指定需要的字段都可以进一步作用在<code>query</code>的结果上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;highlight&quot;:&#123; # 高亮显示</span><br><span class="line">  &quot;fields&quot;:&#123;  # 指定高亮的字段</span><br><span class="line">    &quot;balance&quot;:&#123;&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;sort&quot;: [  # 指定排序条件</span><br><span class="line">  &#123; &quot;account_number&quot;: &quot;asc&quot; &#125; # 按照账户余额降序</span><br><span class="line">],</span><br><span class="line">&quot;from&quot;: 0, # 分页</span><br><span class="line">&quot;size&quot;: 10, # 每页的大小4,通过执行size=0,可以实现仅显示聚合结果而不显示命中的信息详情</span><br><span class="line">&quot;_source&quot;: [&quot;account_number&quot;, &quot;balance&quot;], # 默认情况下,ES会返回全文JSON,通过_source可以指定返回的字段</span><br></pre></td></tr></table></figure>

<h3 id="聚合分析"><a href="#聚合分析" class="headerlink" title="聚合分析"></a>聚合分析</h3><p><strong>聚合分析是基于doc value这样一个数据结果进行的,前面有说过,这个doc value 其实就是正排索引, 聚合分析就是根据某一个字段进行分组,要求这个字段是不能被分词的,如果被聚合的字段被分词,按照倒排索引的方式去索引的话,就不得不去扫描整个倒排索引(才可能将被聚合的字段找全,效率很低)</strong><br>三个概念:</p>
<ul>
<li>什么是bucket?<br>bucket就是聚合得到的结果</li>
<li>什么是metric?<br>metric就是对bucket进行分析,如最最大值,最小值,平均值</li>
<li>什么是下钻?<br>下钻就是在现有的分好组的bucket继续分组,比如一个先按性别分组,再按年龄分组</li>
</ul>
<p>聚合的关键字: <code>aggs</code> 和 <code>query</code>地位并列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">  # 使用聚合时,天然存在一个metric,就是当前bucket的count</span><br><span class="line">  &quot;aggs&quot;: &#123; # 聚合</span><br><span class="line">    &quot;group_by_state&quot;: &#123; # 自定义的名字</span><br><span class="line">      &quot;term&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;balance&quot; # 指定聚合的字段, 意思是 group by balance</span><br><span class="line">      &#125;,</span><br><span class="line">       &quot;terms&quot;: &#123; # terms</span><br><span class="line">        &quot;field&quot;: &#123;&quot;value1&quot;,&quot;value2&quot;,&quot;value3&quot;&#125; # 指定聚合的字段, 意思是 group by balance</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,    </span><br><span class="line">  &quot;aggs&quot;: &#123; # 聚合中嵌套聚合</span><br><span class="line">    &quot;group_by_state&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;field1&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123; # 聚合中嵌套聚合</span><br><span class="line">        &quot;average_balance&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;field2&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">   &quot;aggs&quot;: &#123; #嵌套聚合,并且使用内部聚合的结果集</span><br><span class="line">    &quot;group_by_state&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;state.keyword&quot;,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;average_balance&quot;: &quot;desc&quot; # 使用的下面聚合的结果集</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;average_balance&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;  # avg 求平均值  metric</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">         &quot;min_price&quot;: &#123;</span><br><span class="line">          &quot;min&quot;: &#123;  # metric 求最小值</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">         &quot;max_price&quot;: &#123;</span><br><span class="line">          &quot;max&quot;: &#123;  # metric 求最大值</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">         &quot;sum_price&quot;: &#123;</span><br><span class="line">          &quot;sum&quot;: &#123;  #  metric 计算总和</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">   &quot;aggs&quot;: &#123; # 先按照年龄分组,在按照性别分组,再按照平均工资聚合</span><br><span class="line">             # 最终的结果就得到了每个年龄段,每个性别的平均账户余额</span><br><span class="line">    &quot;group_by_age&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 20,</span><br><span class="line">            &quot;to&quot;: 30</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_gender&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;gender.keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;average_balance&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      # histogram,类似于terms, 同样会进行bucket分组操作,接受一个field,按照这个field的值的各个范围区间进行分组操作</span><br><span class="line">      # 比如我们指定为2000, 它会划分成这样 0-2000  2000-4000  4000-6000 ...</span><br><span class="line">      &quot;aggs&quot;: &#123; # 聚合中嵌套聚合  </span><br><span class="line">         &quot;group_by_price&quot;: &#123;</span><br><span class="line">              &quot;histogram&quot;: &#123;</span><br><span class="line">                 &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">                 &quot;interval&quot;:2000</span><br><span class="line">             &#125;,</span><br><span class="line">         &quot;aggs&quot;: &#123; # 聚合中嵌套聚合</span><br><span class="line">             &quot;average_price&quot;: &#123;</span><br><span class="line">               &quot;avg&quot;: &#123;</span><br><span class="line">                  &quot;field&quot;: &quot;price&quot;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;sales_over_time&quot; : &#123; # 根据日期进行聚合</span><br><span class="line">            &quot;date_histogram&quot; : &#123;</span><br><span class="line">                &quot;field&quot; : &quot;date&quot;,</span><br><span class="line">                &quot;interval&quot; : &quot;1M&quot;,# 一个月为一个跨度</span><br><span class="line">                &quot;format&quot; : &quot;yyyy-MM-dd&quot;,</span><br><span class="line">                &quot;min_doc_count&quot;:0 #即使这个区间中一条数据都没有,这个区间也要返回</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="filter-aggregate"><a href="#filter-aggregate" class="headerlink" title="filter aggregate"></a>filter aggregate</h4><p>过滤加聚合,统计type=t-shirt的平均价格</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;t_shirts&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123; &quot;term&quot;: &#123; &quot;type&quot;: &quot;t-shirt&quot; &#125; &#125;,</span><br><span class="line">            &quot;aggs&quot; : &#123;</span><br><span class="line">                &quot;avg_price&quot; : &#123; &quot;avg&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="嵌套聚合-广度优先"><a href="#嵌套聚合-广度优先" class="headerlink" title="嵌套聚合-广度优先"></a>嵌套聚合-广度优先</h4><p>说一个应用于场景: 我们检索电影的评论, 但是我们先按照演员分组聚合,在按照评论的数量进行聚合</p>
<p>分析: 如果我们选择深度优先的话, ES在构建演员电影相关信息时,会顺道计算出电影下面评论数的信息,假如说有10万个演员的话, 10万*10=100万个电影 每个电影下又有很多影评,接着处理影评, 就这样内存中可能会存在几百万条数据,但是我们最终就需要50条,这种开销是很大的</p>
<p>广度优先的话,是我们先处理电影数,而不管电影的评论数的聚合情况,先从10万演员中干掉99990条数据,剩下10个演员再聚合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;aggs&quot;:&#123;</span><br><span class="line">    &quot;target_actors&quot;:&#123;</span><br><span class="line">        &quot;terms&quot;:&#123;</span><br><span class="line">            &quot;field&quot;:&quot;actors&quot;,</span><br><span class="line">            &quot;size&quot;:10,</span><br><span class="line">            &quot;collect_mode&quot;:&quot;breadth_first&quot; # 广度优先</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="global-aggregation"><a href="#global-aggregation" class="headerlink" title="global aggregation"></a>global aggregation</h4><p>全局聚合,下面先使用query进行全文检索,然后进行聚合, 下面的聚合实际上是针对两个不同的结果进行聚合,第一个聚合添加了global关键字,意思是ES中存在的所有doc进行聚合计算得出t-shirt的平均价格</p>
<p>第二个聚合针对全文检索的结果进行聚合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123; &quot;type&quot; : &quot;t-shirt&quot; &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;all_products&quot; : &#123;</span><br><span class="line">            &quot;global&quot; : &#123;&#125;, </span><br><span class="line">            &quot;aggs&quot; : &#123; </span><br><span class="line">                &quot;avg_price&quot; : &#123; &quot;avg&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;t_shirts&quot;: &#123; &quot;avg&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Cardinality-Aggregate-基数聚合"><a href="#Cardinality-Aggregate-基数聚合" class="headerlink" title="Cardinality Aggregate 基数聚合"></a>Cardinality Aggregate 基数聚合</h4><p>作用类似于<code>count(distcint)</code>,会对每一个bucket中指定的field进行去重,然后取去重后的count</p>
<p>虽然她会存在5%左右的错误率,但是性能特别好</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;type_count&quot; : &#123;</span><br><span class="line">            &quot;cardinality&quot; : &#123; # 关键字</span><br><span class="line">                &quot;field&quot; : &quot;type&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对Cardinality Aggregate的性能优化, 添加 <code>precision_threshold</code> 优化准确率和内存的开销</p>
<p>下面的示例中将<code>precision_threshold</code>的值调整到100意思是当 type的类型小于100时,去重的精准度为100%, 此时内存的占用情况为 100*8=800字节</p>
<p>加入我们将这个值调整为1000,意思是当type的种类在1000个以内时,去重的精准度100%,内存的占用率为1000*8=80KB</p>
<p>官方给出的指标是, 当将<code>precision_threshold</code>设置为5时,错误率会被控制在5%以内</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;type_count&quot; : &#123;</span><br><span class="line">            &quot;cardinality&quot; : &#123; # 关键字</span><br><span class="line">                &quot;field&quot; : &quot;type&quot;,</span><br><span class="line">                &quot;precision_threshold&quot;:100</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进一步优化,Cardinality底层使用的算法是 HyperLogLog++, 可以针对这个算法的特性进行进一步的优化,因为这个算法的底层会对所有的 unique value取hash值,利用这个hash值去近似的求distcint count, 因此我们可以在创建mapping时,将这个hash的求法设置好,添加doc时,一并计算出这个hash值,这样 HyperLogLog++ 就无需再计算hash值,而是直接使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT /index/</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;:&#123;</span><br><span class="line">        &quot;my_type&quot;:&#123;</span><br><span class="line">            &quot;properties&quot;:&#123;</span><br><span class="line">                &quot;my_field&quot;:&#123;</span><br><span class="line">                    &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">                    &quot;fields&quot;:&#123;</span><br><span class="line">                        &quot;hash&quot;:&#123;</span><br><span class="line">                            &quot;type&quot;:&quot;murmu3&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="控制聚合的升降序"><a href="#控制聚合的升降序" class="headerlink" title="控制聚合的升降序"></a>控制聚合的升降序</h4><p>先按照颜色聚合,在聚合的结果上,再根据价格进行聚合, 最终的结果中,按照价格聚合的分组中升序排序, 这算是个在下转分析时的排序技巧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /index/type/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;:0,</span><br><span class="line">     &quot;aggs&quot;:&#123;</span><br><span class="line">         &quot;group_by_color&quot;:&#123;</span><br><span class="line">             &quot;term&quot;:&#123;</span><br><span class="line">                 &quot;field&quot;:&quot;color&quot;,</span><br><span class="line">                 &quot;order&quot;:&#123; # </span><br><span class="line">                     &quot;avg_price&quot;:&quot;asc&quot;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;aggs&quot;:&#123;</span><br><span class="line">             &quot;avg_price&quot;:&#123;</span><br><span class="line">                 &quot;avg&quot;:&#123;</span><br><span class="line">                     &quot;field&quot;:&quot;price&quot;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Percentiles-Aggregation"><a href="#Percentiles-Aggregation" class="headerlink" title="Percentiles Aggregation"></a>Percentiles Aggregation</h4><p>计算百分比, <strong>常用它计算如,在200ms内成功访问网站的比率,在500ms内成功访问网站的比例,在1000ms内成功访问网站的比例, 或者是销售价为1000元的商品,占总销售量的比例, 销售价为2000元的商品占总销售量的比例等等</strong></p>
<p>示例: 针对doc中的 load_time字段, 计算出在不同百分比下面的 load_time_outliner情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">GET latency/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;load_time_outlier&quot; : &#123;</span><br><span class="line">            &quot;percentiles&quot; : &#123;</span><br><span class="line">                &quot;field&quot; : &quot;load_time&quot; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 解读: 在百分之50的加载请求中,平均load_time的时间是在445.0, 在99%的请求中,平均加载时间980.1</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">   &quot;aggregations&quot;: &#123;</span><br><span class="line">      &quot;load_time_outlier&quot;: &#123;</span><br><span class="line">         &quot;values&quot; : &#123;</span><br><span class="line">            &quot;1.0&quot;: 9.9,</span><br><span class="line">            &quot;5.0&quot;: 29.500000000000004,</span><br><span class="line">            &quot;25.0&quot;: 167.5,</span><br><span class="line">            &quot;50.0&quot;: 445.0,</span><br><span class="line">            &quot;75.0&quot;: 722.5,</span><br><span class="line">            &quot;95.0&quot;: 940.5,</span><br><span class="line">            &quot;99.0&quot;: 980.1000000000001</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 还可以自己指定百分比跨度间隔</span><br><span class="line"></span><br><span class="line">GET latency/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;load_time_outlier&quot; : &#123;</span><br><span class="line">            &quot;percentiles&quot; : &#123;</span><br><span class="line">                &quot;field&quot; : &quot;load_time&quot;,</span><br><span class="line">                &quot;percents&quot; : [95, 99, 99.9] </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>优化: percentile底层使用的是 TDigest算法,用很多个节点执行百分比计算,近似估计,有误差,节点越多,越精准</p>
<p>可以设置<code>compression</code>的值, 默认是100 , ES限制节点的最多是 <code>compression</code>*20 =2000个node去计算 , 因为节点越多,性能就越差</p>
<p>一个节点占用 32字节, 1002032 = 64KB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET latency/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;load_time_outlier&quot; : &#123;</span><br><span class="line">            &quot;percentiles&quot; : &#123;</span><br><span class="line">                &quot;field&quot; : &quot;load_time&quot;,</span><br><span class="line">                &quot;percents&quot; : [95, 99, 99.9],</span><br><span class="line">                &quot;compression&quot;:100 # 默认值100</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="优化相关性得分"><a href="#优化相关性得分" class="headerlink" title="优化相关性得分"></a>优化相关性得分</h2><ul>
<li>第一种方式:</li>
</ul>
<p>在content字段中全文检索 <code>java elasticsearch</code>时,给title中同时出现<code>java elasticsearch</code>的doc的权重加倍</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">      &quot;bool&quot; : &#123;# 前缀匹配</span><br><span class="line">         &quot;match&quot;:&#123;</span><br><span class="line">            &quot;content&quot;:&#123;</span><br><span class="line">                 &quot;query&quot;:&quot;java elasticsearch&quot;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;should&quot;:[</span><br><span class="line">             &quot;match&quot;:&#123;</span><br><span class="line">                 &quot;title&quot;:&#123;</span><br><span class="line">                     &quot;query&quot;:&quot;java elasticsearch&quot;,</span><br><span class="line">                     &quot;boost&quot;:2</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         ]</span><br><span class="line">       &#125; </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第二种: 更换写法,改变占用的权重比例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">     &quot;should&quot;:[</span><br><span class="line">      &#123; &quot;match&quot;:&#123;&quot;title&quot;:&quot;this is&quot;&#125;&#125;,  # 1/3</span><br><span class="line">      &#123; &quot;match&quot;:&#123;&quot;title&quot;:&quot;this is&quot;&#125;&#125;,  # 1/3</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;bool&quot;:&#123;</span><br><span class="line">         &quot;should&quot;:[</span><br><span class="line">           &#123;&quot;match&quot;:&#123;&quot;title&quot;:&quot;this is&quot;&#125;&#125;, # 1/6</span><br><span class="line">           &#123;&quot;match&quot;:&#123;&quot;title&quot;:&quot;this is&quot;&#125;&#125;  # 1/6</span><br><span class="line">           ]</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   ] </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第三种: 如果不希望使用相关性得分,使用下面的语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;constant_score&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">              &quot;term&quot; : &#123; &quot;title&quot; : &quot;this&quot;&#125; #</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;boost&quot; : 1.2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第四种: 灵活的查询</li>
</ul>
<p>查询必须包含XXX,必须不包含YYY的doc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">          &quot;title&quot;:&quot;this is a &quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">           &quot;title&quot;:&quot;another&quot;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第五种: 查询必须包含XXX,可以包含YYY,但是包含了YYY后它的权重就会减少指定的值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;boosting&quot;: &#123;</span><br><span class="line">      &quot;positive&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">          &quot;title&quot;:&quot;this is a &quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">           &quot;title&quot;:&quot;another&quot;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">       &quot;negative_boost&quot;: 0.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第六种: 重打分机制</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123; </span><br><span class="line">   &quot;match&quot;:&#123;</span><br><span class="line">       &quot;title&quot;:&#123;</span><br><span class="line">           &quot;query&quot;:&quot;java elasticsearch&quot;,</span><br><span class="line">           &quot;minimum_should_match&quot;:&quot;50%&quot;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;rescore&quot;:&#123; # 对全文检索的结果进行重新打分</span><br><span class="line">       &quot;window_size&quot;:50,  # 对全文检索的前50条进行重新打分</span><br><span class="line">       &quot;query&quot;: &#123; </span><br><span class="line">           &quot;rescore_query&quot;:&#123; # 关键字</span><br><span class="line">                &quot;match_phrase&quot;:&#123; # match_phrase + slop 感知 term persition,贡献分数</span><br><span class="line">                   &quot;title&quot;:&#123;</span><br><span class="line">                       &quot;query&quot;:&quot;java elasticsearch&quot;,</span><br><span class="line">                       &quot;slop&quot;:50</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第七种: 混用match和match_phrase提高召回率</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123; </span><br><span class="line">  &quot;bool&quot;: &#123;  </span><br><span class="line">  &quot;must&quot;:  &#123;</span><br><span class="line">      # 全文检索虽然可以匹配到大量的文档,但是它不能控制词条之间的距离</span><br><span class="line">      # 可能java elasticsearch在Adoc中距离很近,但是它却被ES排在结果集的后面</span><br><span class="line">      # 它的性能比match_phrase高10倍,比proximity高20倍</span><br><span class="line">     &quot;match&quot;: &#123;</span><br><span class="line">        &quot;address&quot;: &quot;java elasticsearch&quot; </span><br><span class="line">        &#125; </span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;should&quot;: &#123;</span><br><span class="line">     # 借助match_phrase+slop可以感知term position的功能,为距离相近的doc贡献分数,让它们靠前排列</span><br><span class="line">      &quot;match_phrase&quot;:&#123;</span><br><span class="line">          &quot;title&quot;:&#123;</span><br><span class="line">              &quot;query&quot;:&quot;java elasticsearch&quot;,</span><br><span class="line">              &quot;slop&quot;:50</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>
  <footer class="article-footer">
    
  <div class="cc">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/deed.z" target="_blank" title="署名-相同方式共享">
      <img src="/images/cc/cc.png">
      
          <img src="/images/cc/by.png">
        
          <img src="/images/cc/sa.png">
      
      <span>
        本作品采用知识共享 署名-相同方式共享 4.0 国际许可协议进行许可。
      </span>
    </a>
  </div>


    

  </footer>
</article>







          <div class="main-footer">
  
    © 2020 BlackC - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

</body>
</html>
