---
title: 大数据协议知识
date: 2021-02-18 15:35:16
categories: 大数据
tags: learn
---

> 空闲整理下协议相关知识

<!-- more -->

## 协议总览
```
ZAB
Paxos
Raft
2PC
Quorum
```

---

## ZAB协议
### 介绍_[ZK选举](https://jxeditor.github.io/2017/08/28/Zookeeper%E7%9A%84%E9%A2%86%E5%AF%BC%E8%80%85%E9%80%89%E4%B8%BE%E5%92%8C%E5%8E%9F%E5%AD%90%E5%B9%BF%E6%92%AD/)
```
全程Zookeeper Atomic Broadcast(ZK原子广播)
使用场景,Zookeeper
过程:
    实现了主备模型的系统架构来保证集群中各个副本之间数据的一致性
    Leader将客户端的操作转化为Proposal,Leader在操作完数据后向所有Follower发送广播请求,等待反馈
    ZAB协议中,超过半数Follower节点反馈成功,Leader向所有Follower发送Commit消息
    Follower进行数据操作.

看上面的过程,Leader先是将操作广播给Follower,等待反馈,然后再将Commit消息发送给Follower.
这个过程和2PC很相似,只不过2PC要么全部反馈成功,要么全部反馈失败(精确一次).
而ZAB只需要半数反馈成功即可.
```
### 疑问点
```
1.为什么ZAB协议不会同步阻塞?
    因为Leader和每一个Follower之间收发消息都有单独的队列,做到了异步.
2.ZAB只要半数反馈成功,怎么保证的数据一致性?
    首先ZAB中只能是Leader接收写请求,其次如果Leader宕机,ZAB要求集群进行崩溃恢复和Leader选举
    其中崩溃恢复必须确保:
        1.已经被Leader提交的Proposal必须被所有Follower提交
        2.丢弃Leader没有提交Proposal(保证Follower没有未提交Proposal,一定比宕机Leader的Proposal小)
    Leader宕机时存在未提交的Proposal在崩溃恢复后,新选举的Leader肯定是换了节点
    新Leader会把自身最大Proposal的ZXID发送给其他Follower
    Follower对比自身Proposal的ZXID,自身大则回退,自身小则进行数据同步.
3.ZXID是什么?
    64位的数字,低32位按照数字递增,客服端发送Proposal,低32位简单加1
    高32位是Leader周期的epoch编号,每选举出新的Leader,Leader都从本地Proposal获取ZXID,解析出高32位epoch编号,进行加1
    低32位全部设置为0,保证ZXID的唯一性,并且递增.
4.Leader崩溃,已经提出但是未提交的Proposal被丢弃,是不是意味着ZK丢失了一次请求?
    我个人认为是丢失了,没有重试机制的话,对应就应该是ZK请求失败.
```

---

## Paxos
### 介绍
```
解决问题:
    每个人都有提出建议,同意建议,接受建议的权利
    最终的采纳哪个建议,采取少数服从多数的方式
采纳方式:
    只有被提出的建议才能被大家同意
    只能采纳一个建议
```
### 流程
```
A,B,C三个人提议吃东西(对吃什么各持己见)
A-->日料
B-->法餐
C-->中餐

提议顺序 A->B->C

Prepare阶段
    A将提议(1)发送给BC
        BC没有接受小于编号为1的提议,BC接受,并不再接受小于1的提议
    B将提议(2)发送给AC
        A没有接受小于编号为2的提议,A接受,并不再接受小于2的提议
        C接受过编号为1的提议,但是2>1,C接受,并不再接受小于2的提议
    C将提议(3)发送给AB
        A接受过编号为2的提议,但是3>2,A接受,并不再接受小于3的提议
        B接受过编号为2的提议,但是3>2,B接受,并不再接受小于3的提议

Accept阶段
    A将提议(1,日料)发送给BC
        B不接受小于3的提议,拒绝
        C不接受小于2的提议,拒绝
        A的票数0,再次进入Prepare阶段
    B将提议(2,法餐)发送给AC
        A不接受小于3的提议,拒绝
        C不接受小于2的提议,接受
        B的票数为1
    C将提议(3,中餐)发送给AB
        A不接受小于3的提议,接受
        B不接受小于3的提议,接受
        C的票数为2

C(3,中餐)获得多数人同意
```
