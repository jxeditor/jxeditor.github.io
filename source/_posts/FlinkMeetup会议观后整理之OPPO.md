---
title: FlinkMeetup会议观后整理之OPPO
date: 2019-06-04 08:59:01
categories: 大数据
tags: 
    - flink
---
> 对于4月份在深圳举行的FlinkMeetup峰会,做一些知识性总结,提升一下自己,OPPO篇其实张俊张老师已经在过往记忆上做过总结整理了-[传送门](https://mp.weixin.qq.com/s/ZZaaN0ubQgLqFwTiySi8UQ),本文更多的是了解自己的不足

---

## 主要内容
- OPPO实时数仓的演进思路
- 基于Flink SQL的扩展条件
- 构建实时数仓的应用案例
- 未来的思考和展望

---
<!-- more -->
## 一、OPPO实时数仓的演进思路
### 1.OPPO业务与数据规模
OPPO基于Android定制了自己的ColorOS系统,日活跃用户超过2亿.围绕着ColorOS,OPPO构建了很多互联网应用,比如应用商店,浏览器,信息流等.用户在使用这些互联网应用的同时,也给OPPO积累了大量的数据.目前OPPO的总数据量超过100PB,日增数据量超过200TB---**数据**.

要支撑这么大的一个数据量,OPPO研发出一整套的数据系统与服务,并逐渐形成了自己的数据中台体系---**数据中台**.

### 2.OPPO数据中台
数据中台是什么?数据中台是指通过数据技术,对海量数据进行采集,计算,存储,加工,同时统一标准和口径.如果将数据看做原材料,那么数据中台就是加工坊.把它分成4个层次:
> **业务支撑**: 应用商店,浏览器,广告等;生产,品质,销售等;手软,ColorOs,影像等;IOT厂商
> 
> **数据产品与服务**: BI报表,用户洞察,内容标签,精准营销,舆情监测
> 
> **全域数据体系**: ID-Mapping,用户标签,内容标签
> 
> **数据仓库**: 原始层,明细层,汇总层,应用层
> 
> **统一工具体系**: 数据接入,数据治理,数据开发,数据消费
>
> **基础设施**: 存储,计算

- 最下层是统一工具体系,涵盖了"接入-治理-开发-消费"全数据链路;
- 基于工具体系之上构建了数据仓库,划分成"原始层-明细层-汇总层-应用层",这也是经典的数仓架构;
- 再往上就是全域的数据体系,什么是全域呢?就是把公司所有的业务数据全部打通,形成统一的数据资产,比如ID-Mapping,用户标签等;
- 最终,数据要能被业务用起来,需要场景驱动的数据产品与服务.

以上就是OPPO数据中台的整个体系,而数据仓库在其中处于非常基础与核心的位置.

### 3.构建OPPO离线数仓
构建过程: 首先,数据来源基本是手机,日志文件以及DB数据库,基于Apache NiFI打造高可用,高吞吐的接入系统,将数据统一落入HDFS,形成原始层;紧接着,基于Hive的小时级ETL与天级汇总Hive任务,分别负责计算生成明细层与汇总层;最后,应用层是基于OPPO内部研发的数据产品,主要是报表分析,用户画像以及接口服务.此外,中间的明细层还支持Presto的**即席查询**与**自助取数**.

### 4.数仓实时化的诉求
> **业务侧**

- 实时报表: 人群投放的到达率/曝光率/点击率
- 实时标签: 用户当前所在的商圈
- 实时接口: 用户最近下载某APP的时间
 
> **平台侧**

- 调度任务: 凌晨0点大批量启动
- 标签导入: 全量导入耗费数小时
- 质量监控: 及时发现数据问题

对于数仓实时化的诉求,大家通常都是从业务视角来看,但其实站在平台的角度,实时化也能带来切实的好处.首先,从业务侧来看,报表,标签,接口等都会有实时的应用场景;其次,对平台侧来说:第一,大量的批量任务都是从0点开始启动,都是通过T+1的方式去做数据处理,这会导致计算负载集中爆发,对集群的压力很大;第二,标签导入也属于一种T+1批量任务,每次全量导入都会耗费很长的时间;第三,数据质量的监控也必须是T+1的,导致没办法及时发现数据的一些问题.

### 5.离线到实现的平滑迁移
<table>
    <tr>
        <th rowspan="4">小时/天级</th>
        <th rowspan="2">API</th>
        <th>编程接口</th>
        <th>SQL+UDF</th>
    </tr>
    <tr>
        <th>数仓抽象</th>
        <th>Table</th>
    </tr>
    <tr>
        <th rowspan="2">RunTime</th>
        <th>批量计算</th>
        <th>Hive</th>
    </tr>
    <tr>
        <th>离线数据</th>
        <th>HDFS</th>
    </tr>
</table>
<table>
    <tr>
        <th rowspan="4">秒级/分级</th>
        <th rowspan="2">API</th>
        <th>编程接口</th>
        <th>SQL+UDF</th>
    </tr>
    <tr>
        <th>数仓抽象</th>
        <th>Table</th>
    </tr>
    <tr>
        <th rowspan="2">RunTime</th>
        <th>流式计算</th>
        <th>Flink</th>
    </tr>
    <tr>
        <th>实时数据</th>
        <th>Kafka</th>
    </tr>
</table>
无论是一个平台还是一个系统,都离不开上下两个层次的构成: 上层是API,是面向用户的编程抽象与接口;下层是RunTime,是面向内核的执行引擎.从离线到实时的迁移是平滑的,是什么意思?从API这层来看,数仓的抽象是Table,编程接口是SQL+UDF,离线数仓时代用户已经习惯了这样的API,迁移到实时数仓最好也能保持一致.而从RunTime层来看,计算引擎从Hive演进到了Flink,存储引擎从HDFS演进到了Kakfa.

### 6.构建OPPO实时数仓
构建过程: 与离线数仓基本相似,只是把Hive替换成Flink,把HDFS替换为Kafka.总体流程来看,基本模型是不变的,还是由原始层,明细层,汇总层,应用层的级联计算来构成.

核心问题: 如何基于Flink构建实时数仓.

---
## 二、基于Flink SQL的扩展工作
### 1.Why Flink SQL
> **SQL**: High-level Language
>
- ANSI SQL + UDF
- 数据类型 + 内置函数
- 自定义Source/Sink
- 批流统一

> **Table API**: Declarative DSL

> **DataStream/DataSet API**: Core APIs

> **Stateful Stream Processing**: Low-level building block(streams,state,[event] time)
>
- 低延迟,高吞吐
- 高容错的状态管理
- 端到端exactly-once
- Windows & Event Time

首先,为什么要用Flink SQL?上面展示了Flink框架的基本结构,最下面是Runtime,这个执行引擎我们认为最核心的优势是四个: 第一,低延迟,高吞吐;第二,端到端的Exactly-once;第三,可容错的状态管理;第四,Window & Event time的支持.基于Runtime抽象出3个层次的API,SQL处于最上层.

Flink SQL API有哪些优势?也可以从四个方面去看: 第一,支持ANSI SQL的标准;第二, 支持丰富的数据类型与内置函数,包括常见的算术运算与统计聚合;第三,可自定义Source/Sink,基于此可以灵活地扩展上下游;第四,批流统一,同样的SQL,既可以跑离线也可以跑实时.

